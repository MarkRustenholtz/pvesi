<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>PV Interpellation ‚Äî ESI</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#003366" />
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
  --brand:#003366;
  --bg:#f4f6fa;
  --text:#222;
  --radius:18px;
  --serif:"Times New Roman", Times, serif;
  --ui:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}

html, body {
  margin:0; padding:0;
  font-family:var(--ui);
  background:var(--bg);
  color:var(--text);
}

header {
  background:var(--brand);
  color:white;
  text-align:center;
  padding:15px 10px;
  font-weight:bold;
  font-size:1.3em;
  letter-spacing:0.5px;
  box-shadow:0 2px 5px rgba(0,0,0,0.3);
  position:sticky;
  top:0;
  z-index:100;
}

/* MENU PRINCIPAL */
#homePage {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:20px;
  padding:25px;
  max-width:700px;
  margin:auto;
}

.menu-btn {
  background:white;
  border-radius:var(--radius);
  padding:25px 10px;
  text-align:center;
  box-shadow:0 3px 8px rgba(0,0,0,0.15);
  transition:all 0.2s ease;
  border:2px solid transparent;
}
.menu-btn:hover {
  transform:scale(1.03);
  border-color:var(--brand);
}
.menu-btn i {
  font-size:2em;
  margin-bottom:10px;
  color:var(--brand);
}
.menu-btn span {
  display:block;
  font-weight:600;
  color:var(--brand);
}

/* SECTIONS */
section {
  display:none;
  padding:20px;
  max-width:980px;
  margin:auto;
}
section.active { display:block; }

.grid {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin-bottom:12px;
  }
fieldset {
  border:1px solid #d0d7de;
  border-radius:10px;
  padding:12px;
  background:#a8c7ff;
  
}

legend {
  padding:0 8px;
  color:#111;
  font-weight:700;
}

label {
  display:block;
  font-size:14px;
  margin:8px 0 4px;
}
input, select, textarea {
  width:100%;
  padding:10px;
  border:1px solid #c9c9c9;
  border-radius:8px;
  font-size:14px;
}

.row {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }

  .row3 {
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:10px;
  }
  
.back-btn {
  display:inline-block;
  background:var(--brand);
  color:white;
  border:none;
  border-radius:8px;
  padding:10px 18px;
  margin-top:15px;
  font-size:1em;
  text-decoration:none;
}
.back-btn:hover { background:#004c9c; }

/* ZONE PV
#sheet {
  width:210mm;
  min-height:297mm;
  background:#fff;
  color:#000;
  font-family:var(--serif);
  padding:10mm;
  display:none;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
}*/

/* ‚úÖ Mise en page identique √† l‚Äô√©cran et au PDF */
#sheet {
  width: 210mm;
  min-height: 297mm;
  display: none;
  grid-template-columns: 58mm 1fr; /* colonne gauche et droite */
  gap: 8mm;
  background: white;
  color: black;
  font-family: "Times New Roman", serif;
  padding: 10mm;
  margin: 30px auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
  box-sizing: border-box;
}

#sheet .col-g {
  border-right: 1px solid #aaa;
  padding-right: 5mm;
}

#sheet .col-d {
  padding-left: 4mm;
  text-align: justify;
  line-height: 1.42;
}

.logo {
  width: 60mm;
  margin: 0 0 8mm 0;
}

.signzone {
  margin-top: 16mm;
  display: grid;
  grid-template-columns: 1fr 1fr;
}

.signcell {
  min-height: 28mm;
  border-top: 1px solid #aaa;
  padding-top: 4mm;
}

/* Impression */
@media print {
  body>*:not(#sheet){display:none !important}
  #sheet{display:grid !important;position:static;margin:0}
}

/* ======== RESPONSIVE DESIGN ======== */

  @media (max-width: 900px) {
    .wrap {
      padding:12px;
      margin:10px;
    }
    .grid, .row, .row3 {
      grid-template-columns:1fr; /* Les champs s‚Äôempilent */
    }
    fieldset {
      padding:10px;
    }
  }

  @media (max-width: 600px) {
    body {
      font-size:15px;
    }
    .toolbar {
      flex-direction:column;
      gap:10px;
    }
    .toolbar button {
      width:100%;
      font-size:16px;
    }
    input, select, textarea {
      font-size:16px; /* √âvite le zoom sur iPhone */
    }
    .wrap {
      padding:10px;
    }
  }

  /* ‚úÖ Correction cibl√©e : emp√™che les champs d'√©criture de d√©passer des cartes */
fieldset input,
fieldset select,
fieldset textarea {
  box-sizing: border-box;
  max-width: 100%;
  width: 100%;
}
/* ‚úÖ Corrige l'espacement du num√©ro de PV (pr√©visualisation) */
.num-pv {
  display: block;
  margin-top: 8mm;      /* espace vertical sous "GENDARMERIE NATIONALE" */
  font-style: italic;
}
#sign_col_g {
  letter-spacing: 1px;
  word-spacing: 20px;
}
</style>
</head>

<body>
<header>PROC√àS-VERBAL D‚ÄôINTERPELLATION ‚Äî App PV</header>

<!-- MENU PRINCIPAL -->
<div id="homePage">
  <div class="menu-btn" onclick="showSection('redacteur')">
    <i class="fa-solid fa-user-pen"></i><span>R√©dacteur</span>
  </div>
  <div class="menu-btn" onclick="showSection('assistants')">
    <i class="fa-solid fa-people-group"></i><span>Assistant(s)</span>
  </div>
  <div class="menu-btn" onclick="showSection('mission')">
    <i class="fa-solid fa-shield-halved"></i><span>Mission</span>
  </div>
  <div class="menu-btn" onclick="showSection('esi')">
    <i class="fa-solid fa-id-card"></i><span>ESI contr√¥l√©</span>
  </div>
  <div class="menu-btn" onclick="showSection('options')">
    <i class="fa-solid fa-gear"></i><span>Options</span>
  </div>
</div>

<!-- SECTION R√âDACTEUR -->
<section id="redacteur">
  <fieldset>
   <legend>ESR (r√©dacteur)</legend>
        <label>Grade</label>
        <input id="esr_grade" placeholder="ex: Gendarme" />
        <label>Nom</label>
        <input id="esr_nom"
       placeholder="NOM"
       style="text-transform:uppercase"
       oninput="this.value=this.value.toUpperCase()"
       autocorrect="off"
       autocapitalize="characters"
       spellcheck="false">
        <label>Pr√©nom</label>
        <input id="esr_prenom" placeholder="Pr√©nom" />
        <label>Sexe ESR (accord de ¬´ assist√©(e) ¬ª)</label>
        <select id="esr_sexe"><option value="m">Masculin</option><option value="f">F√©minin</option></select>
     <label>Qualit√©</label>
<select id="esr_qualite">
  <option value="">‚Äî S√©lectionner ‚Äî</option>
  <option value="APJA">APJA</option>
  <option value="APJ">APJ</option>
  <option value="OPJ">OPJ</option>
  <option value="AFP">AFP</option>
</select>



        <label>Affectation</label>
        <input id="esr_affect" placeholder="ex: CRT 06/1 Nice" />
        <div class="row">
          <div>
            <label>Num√©ro de PV</label>
            <input id="pv_num" placeholder="(ex: 2025 / )" />
          </div>
          <div>
  </fieldset>
  <a href="#" class="back-btn" onclick="backHome()">‚¨Ö Retour</a>
</section>

<!-- SECTION ASSISTANTS -->
<section id="assistants">
  <fieldset>
   <legend>Assistants (multi)</legend>
        <div id="assist_list"></div>
        <button type="button" class="add-btn" onclick="addAssistant()">
  <i class="fa-solid fa-user-plus"></i> Ajouter un assistant
</button>
    </fieldset>
  <a href="#" class="back-btn" onclick="backHome()">‚¨Ö Retour</a>
</section>

<!-- SECTION MISSION -->
<section id="mission">
  <fieldset>
    <legend>Mission</legend>
    <label>Lieu de mission</label>
    <input id="mission_lieu" placeholder="ex: La Turbie" />
    <div class="row">
      <div>
        <label>Heure d√©but</label>
        <input id="mission_hdeb" type="time" />
      </div>
      <div>
        <label>Heure fin</label>
        <input id="mission_hfin" type="time" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Date (lettres)</label>
        <input id="date_lettres" placeholder="17 Juillet" />
      </div>
      <div>
        <label>Heure avant constatation</label>
        <input id="heure_lettres" type="time" />
      </div>
    </div>
  </fieldset>
  <a href="#" class="back-btn" onclick="backHome()">‚¨Ö Retour</a>
</section>

<!-- SECTION ESI CONTR√îL√â -->
<section id="esi">
  <fieldset>
    <legend>ESI contr√¥l√©</legend>
        <div class="row">
          <div>
            <label>Heure de constatation (lettres)</label>
            <input id="esi_hconstat" type="time" placeholder="16 heures et 30 minutes" />
          </div>
          <div>
           <label for="veh_type">V√©hicule/Pieton</label>

<select id="veh_type">
  <option value="" selected disabled>‚Äî S√©lectionner ‚Äî</option>
  <option value="bus">Bus</option>
  <option value="train">Train</option>
  <option value="VL">V√©hicule l√©ger</option>
  <option value="PL">Poids lourd</option>
  <option value="personne">Personne</option>
</select>
          </div>
        </div>
		<label>Marque du v√©hicule/Compagnie du train</label>
<input id="veh_marque"placeholder="ex:Mercedes,Renault/Train ex: Tranitalia" />

        <label>Immatriculation / n¬∞ de train</label>
        <input id="veh_immat" 
       placeholder="AA-123-BB / TGV 6123" 
       style="text-transform:uppercase" 
       oninput="this.value=this.value.toUpperCase()" 
       autocorrect="off" 
       autocapitalize="characters" 
       spellcheck="false">
		<label>Pays d‚Äôimmatriculation</label>
<input id="veh_pays" placeholder="ex: Italie" />
<label>Conducteur / Conductrice</label>
<select id="conducteur_genre">
  <option value="m">Conducteur</option>
  <option value="f">Conductrice</option>
</select>

        <label>Lieu du contr√¥le</label>
        <input id="lieu_controle" placeholder="SUR l'aire de repos /le bas c√¥t√©/le quai de gare" 
autocapitalize="off"
       autocorrect="off"
       spellcheck="false">
        <label>Pi√®ce d‚Äôidentit√© pr√©sent√©e</label>
        <input id="piece_id" placeholder="ex: passeport sans visa/ titre de s√©jour p√©rim√©"
autocapitalize="off"
       autocorrect="off"
       spellcheck="false">
        <div class="row3">
          <div>
<small>‚ö†Ô∏èSI PAS DE PIECE D'IDENTIT√â NE RIEN ECRIRE‚ö†Ô∏è
            <label>Nom</label>
            <input id="esi_nom"
       placeholder="NOM ESI"
       style="text-transform:uppercase"
       oninput="this.value=this.value.toUpperCase()"
       autocorrect="off"
       autocapitalize="characters"
       spellcheck="false">
          </div>
          <div>
            <label>Pr√©nom</label>
            <input id="esi_prenom" placeholder="pr√©nom esi" />
          </div>
          <div>
            <label>Sexe</label>
            <select id="esi_sexe"><option value="m">Masculin</option><option value="f">F√©minin</option></select>
          </div>
        </div>
        <div class="row3">
          <div>
            <label>Date de naissance</label>
            <input id="esi_dnaiss" placeholder="01/01/1992" />
          </div>
          <div>
            <label>Lieu de naissance</label>
            <input id="esi_lnaiss" placeholder="ex:DAKAR (SENEGAL)"
style="text-transform:uppercase" 
       oninput="this.value=this.value.toUpperCase()" 
       autocorrect="off" 
       autocapitalize="characters" 
       spellcheck="false">
          </div>
          <div>
            <label>Nationalit√©</label>
            <input id="esi_nat" placeholder="ex: s√©n√©galaise" 
autocapitalize="off"
       autocorrect="off"
       spellcheck="false">
          </div>
        </div>
		<label>Langue parl√©e</label>
<select id="esi_langue">
  <option value="fr_ok">Parle fran√ßais</option>
  <option value="fr_approx">Fran√ßais approximatif</option>
  <option value="npf">Ne parle pas fran√ßais</option>
</select>

        <div class="row3">
          <div>
            <label>FPR</label>
            <select id="fpr"><option>N√©gatif</option><option>Positif</option></select>
          </div>
          <div>
            <label>AGDREF</label>
            <select id="agdref"><option>N√©gatif</option><option>Positif</option></select>
          </div>
          <div>
            <label>Fichiers nationaux (ex:OQTF,RAS,AUTRE)</label>
            <input id="fichiers_nat" placeholder="OQTF" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Palpation (genre de l‚Äôagent qui palpe)</label>
            <select id="palp_genre"><option value="m">Masculin</option><option value="f">F√©minin</option></select>
          </div>
          <div>
            <label>V√©hicule de transport</label>
            <select id="transport_type"><option>GENDARMERIE</option><option>Translation Police</option></select>
          </div>
        </div>
        <label>PAF de pr√©sentation (ville)</label>
        <input id="paf_ville" placeholder="Menton / Nice / A√©roport" />
		<label>Heure de pr√©sentation √† la PAF</label>
<input id="paf_heure" type="time" placeholder="ex: 17 heures et 10 minutes" />
  </fieldset>
  <a href="#" class="back-btn" onclick="backHome()">‚¨Ö Retour</a>
</section>

<!-- SECTION OPTIONS -->
<section id="options">
  <div class="toolbar" style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;">
  <a href="#" class="back-btn" onclick="backHome()">‚¨Ö Retour</a>
    <button onclick="generatePV()">üßæ G√©n√©rer le PV</button>
    <button class="secondary" onclick="openPrintPreview()">üñ®Ô∏è Imprimer / PDF</button>
    <button onclick="sauvegarderPV()">üíæ Sauvegarder le PV</button>
    <button onclick="ouvrirMesPV()">üìÅ Mes PV sauvegard√©s</button>
    <button onclick="nouveauPV()">üÜï Nouveau PV</button>
	 
  </div>
   <h2>Proc√®s-verbal g√©n√©r√©</h2>
   <div id="sheet">
    <div class="col-g">
      <div class="title-left">MINISTERE DE L'INTERIEUR</div>
      <div style="margin-top:2mm"></div>
      <hr style="border:none;border-top:1px solid #000;margin:3mm 0 2mm 0">
      <div class="title-left" style="white-space:pre-line">DIRECTION GENERALE
DE LA POLICE NATIONALE

DIRECTION G√âN√âRALE DE LA GENDARMERIE     NATIONALE</div>
      <div class="num-pv">NUM√âRO DE P.V. : <span id="pv_num_o"></span></div>

      <div style="margin-top:8mm">AFFAIRE :</div>
     
      <div style="margin-top:8mm"><span id="esi_civil_left_o">Monsieur</span> <span id="aff_nomcomplet_o">Nom Pr√©nom</span></div>
      <div style="margin-top:6mm">OBJET :</div>
      <div>Rapport de saisine</div>
      <div style="margin-top:6mm">SAISINE :</div>
      <div>Interpellation d‚Äô√©tranger en situation irr√©guli√®re.</div>

      <div id="sign_col_g" style="margin-top:18mm">L‚Äôassistant L‚ÄôAPJA</div>
    </div>

    <div class="col-d">
      <div style="text-align:center;font-weight:bold;font-size:1.6em;letter-spacing:1px;">
  R√âPUBLIQUE FRAN√áAISE
</div>
<div style="text-align:center;font-weight:bold;margin-top:3mm;font-size:1.3em;">
  RAPPORT DE SAISINE
</div>
<div style="height:10mm;"></div>

      <p>L'an deux mil vingt-cinq,</p>
      <p>Le <span id="date_lettres_o">17 Juillet</span>, √† <span id="heure_lettres_o">16 heures et 25 minutes</span></p>
      <p>NOUS :</p>

      <p>Soussign√©, <span id="esr_grade_o">Grade</span> <span id="esr_nom_o">Nom</span> <span id="esr_prenom_o">Pr√©nom</span>, <span id="esr_qualite_o">Agent de Police Judiciaire Adjoint / APJA</span>, affect√© √† la <span id="esr_affect_o">CRT 06/1 Nice</span>,</p>

      <p>Assist√©<span id="assist_e_o"> </span> du <span id="assist_list_o">Grade Nom Pr√©nom, Agent de Police Judiciaire Adjoint (APJA), affect√© √† la CRT</span></p>

      <p>En fonction du Groupement de Gendarmerie D√©partementale des Alpes Maritimes, et d√©tach√©s pour emplois au profit de Lutte contre l‚ÄôImmigration Irr√©guli√®re et Clandestine, dans le cadre du dispositif Border Force 06</p>

      <p>‚Äî Nous trouvant en mission de lutte contre l‚Äôimmigration irr√©guli√®re et clandestine dans le d√©partement des Alpes-Maritimes (06) au point de passage autoris√© de <span id="mission_lieu_o">la Turbie</span> ce jour de <span id="mission_hdeb_o">15</span> √† <span id="mission_hfin_o">23</span> . ‚Äî</p>

      <p>‚Äî Mis temporairement et nominativement √† la disposition de Monsieur le Pr√©fet des Alpes-Maritimes, aux fins d'assurer une mission de lutte contre l'immigration irr√©guli√®re dans le d√©partement des Alpes-Maritimes, ‚Äî</p>

      <p>‚Äî Agissant conform√©ment aux instructions re√ßues de Madame la Commissaire Divisionnaire Emmanuelle JOUBERT, Cheffe du Service D√©partemental de la Police aux Fronti√®res des Alpes-Maritimes, ‚Äî</p>

      <p>‚Äî Vu l'article 21-1 du code de proc√©dure p√©nale, ‚Äî</p>
      <p>‚Äî Vu les articles 20, D13 D14 et D15 du code de proc√©dure p√©nale,</p>
      <p>‚Äî Plac√©s sous l'√©gide de la coordination d√©partementale de la police aux fronti√®res pour assurer la mission de contr√¥le des points de passage frontaliers, ‚Äî</p>
      <p>‚Äî Vu le titre II du r√®glement (UE) 2016/399 du Parlement europ√©en et du Conseil du 9 mars 2016 concernant un code de l‚ÄôUnion relatif au r√©gime de franchissement des fronti√®res par les personnes (code fronti√®re Schengen) JO L 077 du 23 mars 2016, p.1. ‚Äî</p>
      <p>‚Äî Vu les articles 5 √† 8, 14 et 32 de ce r√®glement. ‚Äî</p>
      <p>‚Äî Vu la note des autorit√©s fran√ßaises notifiant au premier Vice-pr√©sident de la commission europ√©enne son intention, √† compter du 1er mai 2025 et jusqu‚Äôau 31 octobre 2025, de prolonger le r√©tablissement des contr√¥les aux fronti√®res int√©rieures de la France avec la Belgique, le Luxembourg, l‚ÄôAllemagne, l‚ÄôItalie, l‚ÄôEspagne, et la conf√©d√©ration Suisse, sur le fondement des articles 25 et 27 du r√®glement 2016/399 susvis√©. ‚Äî</p>
      <p>‚Äî Rev√™tus de nos uniformes r√©glementaires et insignes aff√©rents √† notre fonction et munis du gilet r√©fl√©chissant GENDARMERIE, ‚Äî</p>
      <div id="texte-vehicule">
      <p>‚Äî √Ä <span id="esi_hconstat_o">(Heure de constatation)</span>, nous constatons la pr√©sence d‚Äôun <span id="veh_type_o">(v√©hicule)</span> <span id="veh_marque_o">(Marque du vehicule)</span> immatricul√© <span id="veh_pays_o">(pays d'immatriculation)</span> sous le num√©ro <span id="veh_immat_o">(immatriculation)</span> en circulation et arrivant dans notre direction  ‚Äî</p>
	  <p>‚Äî Faisons signe r√©glementairement <span id="conducteur_article_o">au</span> <span id="conducteur_label_o">(conducteur)</span> de stationner son v√©hicule correctement et en s√©curit√© <span id="lieu_controle_o">sur le parking de l‚Äôaire de repos du p√©age de La Turbie</span>, afin de proc√©der au contr√¥le de l‚Äôidentit√© des passagers du v√©hicule. ‚Äî</p>
      <p>‚Äî <span id="conducteur_article2_o">Le</span> <span id="conducteur_label2_o">conducteur</span> obtemp√®re √† notre demande, d√©clinons notre qualit√© et le motif de notre contr√¥le. ‚Äî</p>
	  <p>‚Äî Proc√©dons au contr√¥le d'identit√© des personnes √† bord du v√©hicule.</p>

      <p id="piece_phrase_o">
‚Äî √Ä son bord, <span id="passager_article_o">un</span> <span id="passager_label_o">passager</span>
<span id="piece_phrase_part_o">est en mesure de nous pr√©senter un passeport</span>.
<span id="individu_phrase_o">Cet individu</span> n‚Äô√©tant pas en mesure de nous pr√©senter de document d‚Äôidentit√© ou de voyage en cours de validit√©,
<span id="passager_pronom_o">ce dernier</span> n‚Äôest donc pas en r√®gle pour voyager, circuler ou s√©journer sur le territoire national fran√ßais. ‚Äî
</p>
</div>
<!-- === TEXTE PI√âTON (neutre complet avec identification ESI) === -->
<div id="texte-pieton" style="display:none">

  <p>‚Äî √Ä <span id="heure_pieton_o">[heure]</span>, nous constatons la pr√©sence d‚Äôun individu circulant √† pied sur <span id="lieu_pieton_o">[lieu]</span> et venant dans notre direction. ‚Äî</p>

  <p>‚Äî √Ä son approche, nous d√©clinons notre qualit√© ainsi que le motif de notre contr√¥le. ‚Äî</p>

  <p>‚Äî Nous lui demandons de pr√©senter un document pouvant justifier de son identit√©, conform√©ment aux dispositions de l‚Äôarticle 78-2 du Code de proc√©dure p√©nale. ‚Äî</p>

  <p id="piece_pieton_o">‚Äî L‚Äôint√©ress√©(e) obtemp√®re et est en mesure de nous pr√©senter un document de type : <span id="piece_type_o">[pi√®ce d'identit√© pr√©sent√©e]</span>. ‚Äî</p>

</div>
      <p>‚Äî Il s‚Äôagit de : ‚Äî</p>

      <p id="esi_lang_phrase_o">
‚Äî <span id="esi_civil_o">Monsieur</span> <span id="esi_nom_o">Nom</span> <span id="esi_prenom_o">Pr√©nom</span> n√©<span id="esi_nee_o"></span> le <span id="esi_dnaiss_o">(date de naissance)</span> √† <span id="esi_lnaiss_o">Ville de naissance</span>, de nationalit√© <span id="esi_nat_o">(nationalit√©)</span>, de sexe <span id="esi_sexe_o">masculin</span>. <span id="langue_phrase_o">L‚Äôindividu s‚Äôexprime en fran√ßais approximatif.</span> <span id="identite_phrase_o">Son identit√© est relev√©e sur les pi√®ces pr√©cit√©es.</span> ‚Äî
</p>


      <p>‚Äî Effectuons des recherches concernant cette personne aupr√®s des fichiers de Police mis √† notre disposition, √† l‚Äôaide de notre tablette de service : ‚Äî</p>
	  <p>‚Äî FPR : <span id="fpr_o">N√©gatif</span> ‚Äî</p>
      <p>‚Äî AGDREF : <span id="agdref_o">N√©gatif</span> ‚Äî</p>
      <p>‚ÄîAux fichiers Nationaux il appert qu‚Äô√† ce jour et sous cette identit√© : <span id="fichiers_nat_o">il a fait l‚Äôobjet d‚Äôune OQTF</span> ‚Äî</p>
      <p>‚Äî Rendons imm√©diatement compte des faits √† l‚ÄôOfficier de Police Judiciaire Territorialement Comp√©tent de permanence du poste de la Police Aux Fronti√®res de <span id="paf_ville_o1">Saint Louis √† Menton</span>, qui nous donne l‚Äôordre de lui pr√©senter <span id="esi_civil2_o">Monsieur</span> <span id="esi_nom2_o">THIAM</span> <span id="esi_prenom2_o">Mamadou Moustapha</span> dans les plus brefs d√©lais. ‚Äî</p>
      <p>‚Äî D√®s lors, nous nous trouvons en pr√©sence <span id="esi_etranger_phrase_o">d‚Äôun √©tranger</span> en situation irr√©guli√®re au voyage, √† la circulation ou au s√©jour sur le territoire national fran√ßais, ‚Äî</p>
      <p>‚Äî Agissant en vertu des articles L813-1 √† L813-16 du Code de l‚ÄôEntr√©e et du S√©jour des √âtrangers et du Droit d‚ÄôAsile, ‚Äî</p>
      <p>‚Äî Informons la personne qu‚Äôelle se trouve en situation irr√©guli√®re sur le territoire national fran√ßais. ‚Äî</p>
      <p>‚Äî Invitons <span id="esi_civil3_o">Monsieur</span> <span id="esi_nom3_o">THIAM</span> <span id="esi_prenom3_o">Mamadou Moustapha</span> √† nous suivre. ‚Äî</p>
      <p>‚Äî <span id="palp_phrase_o">Palp√© par mesure de s√©curit√©, par un personnel masculin, il n‚Äôest trouv√© porteur d‚Äôaucun objet dangereux pour autrui ou pour lui-m√™me</span>. ‚Äî</p>
      <p>‚Äî <span id="transport_phrase_o">
Transportons l‚Äôindividu sans contrainte ni entraves au poste de la Police Aux Fronti√®res de Saint Louis √† Menton, √† bord de notre v√©hicule de service s√©rigraphi√© ¬´ GENDARMERIE ¬ª.
</span> ‚Äî</p>
      <p>‚Äî Pr√©sentons l‚Äôindividu devant l‚ÄôOfficier de Police Judiciaire Territorialement Comp√©tent de permanence du poste de la Police Aux Fronti√®res de <span id="paf_ville_o3">Saint Louis √† Menton</span> √† <span id="paf_heure_o">17 heures et 10 minutes</span>. L‚Äôhoraire de pr√©sentation √©tant diff√©r√© eu √©gard au d√©lai de route. ‚Äî</p>

		<div class="signzone">
        
        <div class="signcell">L‚ÄôAPJA</div>
		<div class="signcell">L‚Äôassistant</div>
      </div>
    </div>
  </div>
  
    <!-- üìÅ Liste des PV sauvegard√©s -->
  <div id="listePV" style="display:none; margin-top:30px;">
    <h3 style="color:#003366;">üìÅ Mes PV sauvegard√©s</h3>
    <div id="listePVcontenu" style="background:white;padding:10px;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.2);"></div>
    <button class="back-btn" onclick="fermerMesPV()">‚¨Ö Retour au PV</button>
  </div>
  <a href="#" class="back-btn" onclick="backHome()">‚¨Ö Retour</a>
</section>


<script>
function showSection(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById('homePage').style.display='none';
  document.getElementById(id).classList.add('active');
}
function backHome(){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById('homePage').style.display='grid';
}
</script>

<script>
  let assistIndex = 0;
  function addAssistant(){
    assistIndex++;
    const wrap = document.getElementById('assist_list');
    const div = document.createElement('div');
    div.style.marginBottom = '8px';
    div.innerHTML = `
      <div class="row">
        <div>
          <label>Grade</label>
          <input id="a_grade_${assistIndex}" placeholder="ex: Gendarme" />
        </div>
        <div>
          <label>Nom</label>
          <input id="a_nom_${assistIndex}" 
       placeholder="NOM"
       style="text-transform:uppercase"
       oninput="this.value=this.value.toUpperCase()"
       autocorrect="off"
       autocapitalize="characters"
       spellcheck="false">
        </div>
      </div>
      <label>Pr√©nom</label>
      <input id="a_prenom_${assistIndex}" placeholder="Pr√©nom" />
     <label>Qualit√©</label>
<select id="a_qual_${assistIndex}">
  <option value="">‚Äî S√©lectionner ‚Äî</option>
  <option value="APJA">APJA</option>
  <option value="APJ">APJ</option>
  <option value="OPJ">OPJ</option>
  <option value="AFP">AFP</option>
</select>


      <label>Affectation</label>
      <input id="a_affect_${assistIndex}" placeholder="ex: CRT 06/2 Cannes" />
      <hr style="margin:10px 0;border:none;border-top:1px dashed #ddd">`;
    wrap.appendChild(div);
  }
  // Un assistant par d√©faut
  addAssistant();

  function setTxt(id, v){ const el=document.getElementById(id); if(el) el.textContent = v || ''; }

  function accordAssistEsr(esrSexe, count){
    // renvoie la cha√Æne √† ins√©rer apr√®s "Assist√©"
    if(count>1) return 's';
    return esrSexe==='f' ? 'e' : '';
  }

  function civilFromSexe(sexe){ return sexe==='f' ? 'Madame' : 'Monsieur'; }
  function sexeLabel(sexe){ return sexe==='f' ? 'f√©minin' : 'masculin'; }
  function neeFromSexe(sexe){ return sexe==='f' ? 'e' : ''; }

// === Conversion automatique des abr√©viations de qualit√© ===
function qualiteLongue(code) {
  switch ((code || '').toUpperCase()) {
    case 'APJA': return 'Agent de Police Judiciaire Adjoint (APJA)';
    case 'APJ':  return 'Agent de Police Judiciaire (APJ)';
    case 'OPJ':  return 'Officier de Police Judiciaire (OPJ)';
    case 'AFP':  return 'Agent de la Force Publique (AFP)';
    default:     return code;
  }
}

  function generatePV(){
  // === Met √† jour le texte pi√©ton avant g√©n√©ration ===
if (typeof majTextePieton === "function") majTextePieton();

	
  // Fonction utilitaire : convertir HH:MM en texte
function heureEnLettres(hhmm) {
  if (!hhmm) return "";
  const [h, m] = hhmm.split(":").map(Number);
  let txt = `${h} heure${h > 1 ? 's' : ''}`;
  if (m > 0) txt += ` et ${m} minute${m > 1 ? 's' : ''}`;
  return txt;
}

    // ESR
    const esr_grade = document.getElementById('esr_grade').value.trim();
    const esr_nom   = document.getElementById('esr_nom').value.trim();
    const esr_prenom= document.getElementById('esr_prenom').value.trim();
    const esr_sexe  = document.getElementById('esr_sexe').value;
    const esr_qual  = document.getElementById('esr_qualite').value.trim();
	const esr_qual_long = qualiteLongue(esr_qual);
    const esr_aff   = document.getElementById('esr_affect').value.trim();


    // Assistants
    const assistants=[];
    for(let i=1;i<=assistIndex;i++){
      const g=document.getElementById('a_grade_'+i)?.value.trim();
      const n=document.getElementById('a_nom_'+i)?.value.trim();
      const p=document.getElementById('a_prenom_'+i)?.value.trim();
      const q=document.getElementById('a_qual_'+i)?.value.trim();
      const a=document.getElementById('a_affect_'+i)?.value.trim();
      if(g&&n&&p) assistants.push({g,n,p,q,a});
    }

    // Mission
    const pv_num = document.getElementById('pv_num').value.trim();
    
    const mission_lieu = document.getElementById('mission_lieu').value.trim();
    const hdeb = document.getElementById('mission_hdeb').value.trim();
    const hfin = document.getElementById('mission_hfin').value.trim();
    const dateL = document.getElementById('date_lettres').value.trim();
    const heureL= document.getElementById('heure_lettres').value.trim();

    // ESI
    const esi_hc = document.getElementById('esi_hconstat').value.trim();
    const veh_type = document.getElementById('veh_type').value;
    const veh_immat= document.getElementById('veh_immat').value.trim();
    const lieu_ctrl = document.getElementById('lieu_controle').value.trim();
	const veh_marque = document.getElementById('veh_marque').value.trim();
    const veh_pays = document.getElementById('veh_pays').value.trim();
    const piece_id = document.getElementById('piece_id').value.trim();
	const conducteur_genre = document.getElementById('conducteur_genre').value;
    const esi_nom = document.getElementById('esi_nom').value.trim();
    const esi_prenom = document.getElementById('esi_prenom').value.trim();
    const esi_sexe = document.getElementById('esi_sexe').value;
    const esi_dnaiss = document.getElementById('esi_dnaiss').value.trim();
    const esi_lnaiss = document.getElementById('esi_lnaiss').value.trim();
    const esi_nat = document.getElementById('esi_nat').value.trim();
    const fpr = document.getElementById('fpr').value;
    const agdref = document.getElementById('agdref').value;
    const fichiersNat = document.getElementById('fichiers_nat').value.trim();
    const palp_genre = document.getElementById('palp_genre').value;
    const transport_type = document.getElementById('transport_type').value;
    const paf_ville = document.getElementById('paf_ville').value.trim();
	const paf_heure = document.getElementById('paf_heure').value.trim();

	// Conversion en lettres
const hdeb_txt = heureEnLettres(hdeb);
const hfin_txt = heureEnLettres(hfin);
const hc_txt = heureEnLettres(esi_hc);
const paf_txt = heureEnLettres(paf_heure);
const heureL_txt = heureEnLettres(heureL);

    // Remplissage colonne gauche
    setTxt('pv_num_o', pv_num);

    // Nom complet affaire / ent√™te si tu veux l‚Äôafficher
    setTxt('aff_nomcomplet_o', (esi_nom+" "+esi_prenom).trim());

    // En-t√™te centre
    setTxt('date_lettres_o', dateL);
    setTxt('heure_lettres_o', heureL_txt);

    // ESR
    setTxt('esr_grade_o', esr_grade||'');
    setTxt('esr_nom_o', esr_nom||'');
    setTxt('esr_prenom_o', esr_prenom||'');
    setTxt('esr_qualite_o', esr_qual_long || '');
    setTxt('esr_affect_o', esr_aff||'');

    // Assistants rendu
    const assistSuffix = accordAssistEsr(esr_sexe, assistants.length);
    setTxt('assist_e_o', assistSuffix); // affiche e / s / vide
   const assistTxt = assistants.length
  ? assistants.map(a=>{
      const qlong = qualiteLongue(a.q || '');
      return `${a.g} ${a.n} ${a.p}${qlong?`, ${qlong}`:''}${a.a?`, affect√© √† la ${a.a}`:''}`;
    }).join('; ')
  : 'Grade Nom Pr√©nom, Agent de Police Judiciaire Adjoint (APJA), affect√© √† la CRT';

    setTxt('assist_list_o', assistTxt);

    // Mission
    setTxt('mission_lieu_o', mission_lieu);
    setTxt('mission_hdeb_o', hdeb_txt);
	setTxt('mission_hfin_o', hfin_txt);

    // V√©hicule / constatation
    setTxt('esi_hconstat_o', hc_txt);
    setTxt(
  'veh_type_o',
  veh_type === 'train'
    ? 'train'
    : veh_type === 'vl'
    ? 'v√©hicule l√©ger'
    : veh_type === 'pl'
    ? 'poids lourd'
    : veh_type === 'personne'
    ? 'individu circulant √† pied'
    : 'autobus'
);

    setTxt('veh_pays_o', veh_pays ? 'en ' + veh_pays : '');
    setTxt('veh_marque_o', veh_marque);
    setTxt('veh_immat_o', veh_immat);
    setTxt('lieu_controle_o', lieu_ctrl);
    setTxt('piece_id_o', piece_id);
// Accord conducteur / conductrice
if (conducteur_genre === 'f') {
  setTxt('conducteur_article_o', '√† la');
  setTxt('conducteur_label_o', 'conductrice');
} else {
  setTxt('conducteur_article_o', 'au');
  setTxt('conducteur_label_o', 'conducteur');
}
// Deuxi√®me accord (Le conducteur / La conductrice)
if (conducteur_genre === 'f') {
  setTxt('conducteur_article2_o', 'La');
  setTxt('conducteur_label2_o', 'conductrice');
} else {
  setTxt('conducteur_article2_o', 'Le');
  setTxt('conducteur_label2_o', 'conducteur');
}

    // Identit√© ESI
    const civil = civilFromSexe(esi_sexe);
    const nee = neeFromSexe(esi_sexe);
    setTxt('esi_civil_o', civil);
	setTxt('esi_civil_left_o', civil);
    setTxt('esi_nom_o', esi_nom);
    setTxt('esi_prenom_o', esi_prenom);
    setTxt('esi_nee_o', nee);
    setTxt('esi_dnaiss_o', esi_dnaiss);
    setTxt('esi_lnaiss_o', esi_lnaiss);
    setTxt('esi_nat_o', esi_nat);
    setTxt('esi_sexe_o', sexeLabel(esi_sexe));


    // Fichiers
    setTxt('fpr_o', fpr);
    setTxt('agdref_o', agdref);
    setTxt('fichiers_nat_o', fichiersNat);

    // PAF / suites
    setTxt('paf_ville_o1', paf_ville);
    setTxt('paf_ville_o2', paf_ville);
    setTxt('paf_ville_o3', paf_ville);

    // Suites ‚Äì civilit√©s r√©p√©t√©es
    setTxt('esi_civil2_o', civil);
    setTxt('esi_nom2_o', esi_nom);
    setTxt('esi_prenom2_o', esi_prenom);

    setTxt('esi_civil3_o', civil);
    setTxt('esi_nom3_o', esi_nom);
    setTxt('esi_prenom3_o', esi_prenom);

    // Palpation & transport
    setTxt('palp_genre_o', palp_genre==='f'?'f√©minin':'masculin');
	// Accord complet de la phrase de palpation selon le sexe de l‚ÄôESI
(() => {
  const target = document.getElementById('palp_phrase_o');
  if (!target) return;

  const agentGenre = palp_genre === 'f' ? "f√©minin" : "masculin";

  if (esi_sexe === 'f') {
    target.textContent = `Palp√©e par mesure de s√©curit√©, par un personnel ${agentGenre}, elle n‚Äôest trouv√©e porteuse d‚Äôaucun objet dangereux pour autrui ou pour elle-m√™me`;
  } else {
    target.textContent = `Palp√© par mesure de s√©curit√©, par un personnel ${agentGenre}, il n‚Äôest trouv√© porteur d‚Äôaucun objet dangereux pour autrui ou pour lui-m√™me`;
  }
})();

    // Phrase de transport selon le type choisi
let phraseTransport = '';
if (transport_type === 'GENDARMERIE') {
  phraseTransport = `Transportons l‚Äôindividu sans contrainte ni entraves au poste de la Police Aux Fronti√®res de ${paf_ville}, √† bord de notre v√©hicule de service s√©rigraphi√© ¬´ GENDARMERIE ¬ª.`;
} else {
  phraseTransport = `Transportons l‚Äôindividu sans contrainte ni entraves au poste de la Police Aux Fronti√®res de ${paf_ville}, √† bord de notre v√©hicule de service de translation mis √† disposition par la Police Nationale.`;
}
setTxt('transport_phrase_o', phraseTransport);
setTxt('paf_heure_o', paf_txt);
// Accord passager / pronom selon le sexe de l'ESI
if (esi_sexe === 'f') {
  setTxt('passager_article_o', 'une');
  setTxt('passager_label_o', 'passag√®re');
  setTxt('individu_phrase_o', 'Cet individu'); // reste neutre administratif
  setTxt('passager_pronom_o', 'cette derni√®re');
} else {
  setTxt('passager_article_o', 'un');
  setTxt('passager_label_o', 'passager');
  setTxt('individu_phrase_o', 'Cet individu');
  setTxt('passager_pronom_o', 'ce dernier');
}

// === Phrase dynamique selon la pi√®ce d‚Äôidentit√© ===
(() => {
  const pieceInput = document.getElementById('piece_id');
  const target = document.getElementById('piece_phrase_part_o');
  if (!pieceInput || !target) {
    console.warn("‚ö†Ô∏è √âl√©ment manquant pour la phrase d'identit√©.");
    return;
  }

  const piece_id = pieceInput.value.trim();
  const phrase = piece_id
    ? `est en mesure de nous pr√©senter une pi√®ce d'identit√© de type: ${piece_id}`
    : `n‚Äôest pas en mesure de nous pr√©senter un document pouvant justifier de son identit√©`;
  
  target.textContent = phrase;
})();

// === Langue parl√©e et relev√© d'identit√© ===
(() => {
  const langueSelect = document.getElementById('esi_langue');
  const pieceInput = document.getElementById('piece_id');
  const langueSpan = document.getElementById('langue_phrase_o');
  const identiteSpan = document.getElementById('identite_phrase_o');

  if (!langueSelect || !langueSpan || !identiteSpan) {
    console.warn("‚ö†Ô∏è √âl√©ment manquant pour la langue ou l'identit√©.");
    return;
  }

  const langue = langueSelect.value;
  const pieceTxt = pieceInput ? pieceInput.value.trim() : '';

  // Phrase sur la langue
  let languePhrase = '';
  if (langue === 'fr_ok') {
    languePhrase = "L‚Äôindividu parle fran√ßais.";
  } else if (langue === 'fr_approx') {
    languePhrase = "L‚Äôindividu s‚Äôexprime en fran√ßais approximatif.";
  } else if (langue === 'npf') {
    languePhrase = "L‚Äôindividu ne parle pas fran√ßais.";
  }

  // Phrase sur le relev√© d'identit√©
  let identitePhrase = '';
  if (pieceTxt) {
    identitePhrase = "Son identit√© est relev√©e sur les pi√®ces pr√©cit√©es.";
  } else {
    identitePhrase = "Son identit√© est relev√©e sur sa d√©claration verbale.";
  }

  // Injection dans le PV
  langueSpan.textContent = languePhrase;
  identiteSpan.textContent = identitePhrase;
})();

// Accord pour "√©tranger / √©trang√®re"
(() => {
  const target = document.getElementById('esi_etranger_phrase_o');
  if (!target) return;
  target.textContent = esi_sexe === 'f' ? "d‚Äôune √©trang√®re" : "d‚Äôun √©tranger";
})();


  /*  // Affiche la feuille
    document.getElementById('sheet').style.display='grid';
    // Scroll vers la feuille pour aper√ßu
    document.getElementById('sheet').scrollIntoView({behavior:'smooth',block:'start'});
  }*/
   const sheet = document.getElementById('sheet');
    if(sheet){
      sheet.style.display = 'grid';
      sheet.style.margin = '30px auto';
      sheet.scrollIntoView({behavior:'smooth', block:'start'});
    }
  }
  
 function openPrintPreview() {
  generatePV();

  setTimeout(() => {
    const sheet = document.getElementById('sheet');
    if (!sheet) {
      alert("‚ö†Ô∏è Impossible de trouver le contenu du PV.");
      return;
    }

    // ü™ü Ouvre une nouvelle fen√™tre pour l'impression
    const printWindow = window.open('', '_blank', 'width=900,height=1000');
    printWindow.document.write(`
      <html>
      <head>
        <title>Proc√®s-verbal</title>
        <style>
          @page {
            size: A4;
            margin: 10mm 10mm 20mm 10mm;
          }
		  @page :first {
  margin-top: 20mm;
  margin-bottom: 20mm;
}
@page :not(:first) {
  margin-top: 15mm;
  margin-bottom: 15mm;
}
          body {
            margin: 0;
            padding: 0;
            background: white;
            color: black;
            font-family: "Times New Roman", serif;
          }
          #sheet {
            width: 210mm;
            height: 297mm;
            display: grid;
            grid-template-columns: 58mm 1fr;
            gap: 8mm;
            padding: 10mm 10mm 10mm 10mm;
            margin: auto;
            box-sizing: border-box;
          }
          #sheet .col-g {
            border-right: 1px solid #aaa;
            padding-right: 5mm;
          }
          #sheet .col-d {
            padding-left: 4mm;
            text-align: justify;
            line-height: 1.42;
          }

          .logo {
            width: 60mm;
            margin: 0 0 8mm 0;
          }
          .title-left { font-weight: bold; }
          .num-pv { margin-top: 8mm; font-style: italic; }
          .signzone {
            margin-top: 16mm;
            display: grid;
            grid-template-columns: 1fr 1fr;
          }
          .signcell {
            min-height: 28mm;
            border-top: 1px solid #aaa;
            padding-top: 4mm;
          }
          @media print {
            body {
              margin: 0;
            }
            #sheet {
              display: grid !important;
              position: static;
              margin: 0 auto;
            }
          }
		  #sign_col_g {
  letter-spacing: 1px;
  word-spacing: 20px;
}
        </style>
      </head>
      <body>
        ${sheet.outerHTML}
      </body>
      </html>
    `);

    printWindow.document.close();
    printWindow.focus();
    printWindow.onload = () => printWindow.print();
  }, 600);
}

// === üíæ SAUVEGARDE AUTOMATIQUE AVEC DEBOUNCE (inclut les assistants dynamiques) ===
let saveTimeout;

// Fonction principale de sauvegarde
function savePV() {
  const data = {};

  // Champs fixes
  const champsFixes = [
    'esr_grade','esr_nom','esr_prenom','esr_sexe','esr_qualite','esr_affect',
    'pv_num','mission_lieu','mission_hdeb','mission_hfin',
    'date_lettres','heure_lettres','esi_hconstat','veh_type','veh_marque',
    'veh_immat','veh_pays','conducteur_genre','lieu_controle','piece_id',
    'esi_nom','esi_prenom','esi_sexe','esi_dnaiss','esi_lnaiss','esi_nat',
    'esi_langue','fpr','agdref','fichiers_nat','palp_genre','transport_type',
    'paf_ville','paf_heure'
  ];

  champsFixes.forEach(id => {
    const el = document.getElementById(id);
    if (el) data[id] = el.value;
  });
 // ‚úÖ Ajout des champs PI√âTON (issus du texte g√©n√©r√©)
  const heurePieton = document.getElementById('heure_pieton_o')?.textContent || '';
  const lieuPieton  = document.getElementById('lieu_pieton_o')?.textContent || '';
  const pieceType   = document.getElementById('piece_type_o')?.textContent || '';
   data.heure_pieton = heurePieton;
  data.lieu_pieton  = lieuPieton;
  data.piece_type   = pieceType;
  
  // Champs dynamiques (assistants)
  const assistants = [];
  document.querySelectorAll('#assist_list > div').forEach((div, index) => {
    const a = {
      grade: div.querySelector(`[id^="a_grade_"]`)?.value || '',
      nom: div.querySelector(`[id^="a_nom_"]`)?.value || '',
      prenom: div.querySelector(`[id^="a_prenom_"]`)?.value || '',
      qualite: div.querySelector(`[id^="a_qual_"]`)?.value || '',
      affect: div.querySelector(`[id^="a_affect_"]`)?.value || ''
    };
    assistants.push(a);
  });
  data.assistants = assistants;

  // Sauvegarde dans le localStorage
  localStorage.setItem('pv_interpellation_data', JSON.stringify(data));
  console.log("‚úÖ PV sauvegard√© automatiquement");
}

// Fonction debounce (attend 3 secondes apr√®s la derni√®re saisie)
function debounceSave() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(savePV, 3000);
}

// Attache l‚Äô√©couteur √† tous les champs existants
function attachListeners() {
  document.querySelectorAll('input, select, textarea').forEach(el => {
    el.removeEventListener('input', debounceSave);
    el.addEventListener('input', debounceSave);
  });
}
attachListeners();

// === RECHARGEMENT AUTOMATIQUE DES DONN√âES ===
window.addEventListener('load', () => {
  const saved = localStorage.getItem('pv_interpellation_data');
  if (!saved) return;
  try {
    const data = JSON.parse(saved);

    // Champs fixes
    Object.keys(data).forEach(id => {
      const el = document.getElementById(id);
      if (el && typeof data[id] === 'string') el.value = data[id];
    });

    // Assistants dynamiques
    if (Array.isArray(data.assistants) && data.assistants.length > 0) {
      document.getElementById('assist_list').innerHTML = ''; // Nettoyage avant recharge
      assistIndex = 0;
      data.assistants.forEach(a => {
        addAssistant();
        const div = document.querySelector(`#assist_list > div:last-child`);
        div.querySelector(`[id^="a_grade_"]`).value = a.grade;
        div.querySelector(`[id^="a_nom_"]`).value = a.nom;
        div.querySelector(`[id^="a_prenom_"]`).value = a.prenom;
        div.querySelector(`[id^="a_qual_"]`).value = a.qualite;
        div.querySelector(`[id^="a_affect_"]`).value = a.affect;
      });
    }
	// ‚úÖ Restauration des champs pi√©ton s‚Äôils existent
if (data.heure_pieton && document.getElementById('heure_pieton_o')) {
  document.getElementById('heure_pieton_o').textContent = data.heure_pieton;
}
if (data.lieu_pieton && document.getElementById('lieu_pieton_o')) {
  document.getElementById('lieu_pieton_o').textContent = data.lieu_pieton;
}
if (data.piece_type && document.getElementById('piece_type_o')) {
  document.getElementById('piece_type_o').textContent = data.piece_type;
}

// ‚úÖ Recalcule affichage pi√©ton si s√©lectionn√©
if (typeof majAffichageType === "function") majAffichageType();
if (typeof majTextePieton === "function") majTextePieton();

   console.log("‚ôªÔ∏è PV restaur√© avec les assistants sauvegard√©s");

  } catch(e) {
    console.error('Erreur chargement PV sauvegard√©', e);
	
  }
});

// === GESTION MULTI-PV ===
let pvCourantId = null; // identifiant du PV en cours d'√©dition

// üîπ Sauvegarde manuelle
function sauvegarderPV() {
  const data = {};
  document.querySelectorAll('input, select, textarea').forEach(el => {
    data[el.id] = el.value;
  });

  const nomESI = document.getElementById('esi_nom').value.trim() || "Inconnu";
  const dateMission = document.getElementById('date_lettres').value.trim() || "Date ?";
  
  // üÜî Si on est en train de modifier un PV existant, on garde le m√™me id
  const id = pvCourantId || Date.now();

  const list = JSON.parse(localStorage.getItem('pv_list') || "[]");
  const index = list.findIndex(pv => pv.id === id);
  const newPV = { id, nomESI, dateMission, data };

  if (index >= 0) {
    list[index] = newPV; // on remplace le PV existant
    alert("üîÑ PV mis √† jour !");
  } else {
    list.push(newPV); // sinon on cr√©e un nouveau
    alert("‚úÖ PV sauvegard√© !");
	 pvCourantId = id;
  }

  localStorage.setItem('pv_list', JSON.stringify(list));
  
  // On vide le flag pour √©viter les doublons si on veut cr√©er un nouveau PV ensuite
  pvCourantId = null;
}


// üîπ Affichage de la page "Mes PV"
function ouvrirMesPV() {
  const listePV = document.getElementById('listePV');
  const contenu = document.getElementById('listePVcontenu');
  const sheet = document.getElementById('sheet');

  if (!listePV || !contenu) {
    alert("Erreur : la zone listePV n'existe pas.");
    return;
  }

  // Masque le PV
  if (sheet) sheet.style.display = 'none';

  // Vide et recharge la liste
  contenu.innerHTML = '';

  // R√©cup√®re les PV enregistr√©s
  const pvList = JSON.parse(localStorage.getItem('pv_list') || '[]');

  if (pvList.length === 0) {
    contenu.innerHTML = "<p>Aucun PV sauvegard√©.</p>";
  } else {
    pvList.forEach((pv, i) => {
      const div = document.createElement('div');
      div.style.borderBottom = "1px solid #ccc";
      div.style.padding = "8px 0";
     div.innerHTML = `
  <strong>${pv.nomESI || 'Sans nom'}</strong><br>
  <small>${pv.dateMission || ''}</small><br>
  <button onclick="chargerPV(${pv.id})">‚úèÔ∏è Modifier</button>
  <button onclick="supprimerPV(${pv.id})" style="color:red;">üóëÔ∏è Supprimer</button>
`;

      contenu.appendChild(div);
    });
  }

  listePV.style.display = 'block';
}

function fermerMesPV() {
  const listePV = document.getElementById('listePV');
  const sheet = document.getElementById('sheet');
  if (listePV) listePV.style.display = 'none';
  if (sheet) sheet.style.display = 'block';
}


function chargerPV(id) {
  const list = JSON.parse(localStorage.getItem('pv_list') || "[]");
  const pv = list.find(p => p.id === id);
  if (!pv) return alert("PV introuvable !");
  
  // R√©injecte toutes les donn√©es dans les champs
  Object.keys(pv.data).forEach(k => {
    const el = document.getElementById(k);
    if (el) el.value = pv.data[k];
  });

  // Sauvegarde l'ID du PV actuellement ouvert
  pvCourantId = id;

  fermerMesPV();
   pvCourantId = id;
  alert("‚úÖ PV charg√© pour modification");
  window.scrollTo({ top: 0, behavior: 'smooth' });
    generatePV();
}


function supprimerPV(id) {
  if (!confirm("Supprimer ce PV ?")) return;
  let list = JSON.parse(localStorage.getItem('pv_list') || "[]");
  list = list.filter(pv => pv.id !== id);
  localStorage.setItem('pv_list', JSON.stringify(list));
  ouvrirMesPV();
}
function nouveauPV() {
  if (!confirm("Cr√©er un nouveau PV vierge ? Les champs (hors r√©dacteur) seront effac√©s.")) return;

  // Champs √† pr√©server (ESR / r√©dacteur)
  const preserve = new Set([
    'esr_grade','esr_nom','esr_prenom','esr_sexe','esr_qualite','esr_affect','pv_num'
  ]);

  // Efface tous les champs sauf ceux du r√©dacteur
  document.querySelectorAll('input, select, textarea').forEach(el => {
    if (!preserve.has(el.id)) {
      if (el.tagName === 'SELECT') el.selectedIndex = 0;
      else el.value = '';
    }
  });

  // R√©initialise les assistants (1 bloc vide)
  const assistList = document.getElementById('assist_list');
  if (assistList) {
    assistList.innerHTML = '';
    if (typeof assistIndex !== 'undefined') assistIndex = 0;
    if (typeof addAssistant === 'function') addAssistant();
  }

  // Cache la feuille g√©n√©r√©e si affich√©e
  const sheet = document.getElementById('sheet');
  if (sheet) sheet.style.display = 'none';

  // On repart sur un nouveau PV (pas de mise √† jour sur l‚Äôancien)
  if (typeof pvCourantId !== 'undefined') pvCourantId = null;

  // (Optionnel) Incr√©ment auto du num√©ro de fiche si tu utilises #fiche_id
  const ficheField = document.getElementById('fiche_id');
  if (ficheField) {
    let last = parseInt(localStorage.getItem('dernier_num_fiche') || '0', 10) + 1;
    localStorage.setItem('dernier_num_fiche', String(last));
    ficheField.value = `FICHE-${String(last).padStart(3, '0')}`;
  }

  // Sauvegarde imm√©diate si ta fonction existe (facultatif)
  if (typeof savePV === 'function') savePV();

  window.scrollTo({ top: 0, behavior: 'smooth' });
  alert("‚úÖ Nouveau PV vierge pr√™t (infos r√©dacteur conserv√©es).");
}

 
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log('‚úÖ Service Worker PV ESI enregistr√© !'))
    .catch(err => console.error('‚ùå Erreur SW:', err));
}
</script>
<script>
// === Texte pi√©ton neutre et complet (avec identification automatique) ===
(function(){
  function majTextePieton(){
    const veh = (document.getElementById("veh_type")?.value || "").toLowerCase();
    if (veh !== "personne") return; // uniquement si pi√©ton

    // Champs du formulaire
    const heure = document.getElementById("esi_hconstat")?.value || "[heure de constatation]";
    const lieu  = document.getElementById("lieu_controle")?.value || "[lieu du contr√¥le]";
    const piece = (document.getElementById("piece_id")?.value ?? "").trim();

    const nom    = document.getElementById("esi_nom")?.value || "[NOM]";
    const prenom = document.getElementById("esi_prenom")?.value || "[Pr√©nom]";
    const naissance = document.getElementById("esi_dnaiss")?.value || "[date de naissance]";
    const lieuNais  = document.getElementById("esi_lnaiss")?.value || "[lieu de naissance]";
    const nationalite = document.getElementById("esi_nat")?.value || "[nationalit√©]";
    const sexe = (document.getElementById("esi_sexe")?.value || "").toLowerCase();

    // R√©cup√©ration des zones de texte dans le PV
    const spanHeure = document.getElementById("heure_pieton_o");
    const spanLieu  = document.getElementById("lieu_pieton_o");
    const phrasePiece = document.getElementById("piece_pieton_o");
    const pieceSpan = document.getElementById("piece_type_o");
    const identiteBloc = document.getElementById("identite_pieton_o");
    const sourceIdentite = document.getElementById("source_identite_o");

    // Remplissage heure/lieu
    if (spanHeure) spanHeure.textContent = heure;
    if (spanLieu)  spanLieu.textContent  = lieu;

    // Accord de "L'int√©ress√©(e)"
    const interesse = (sexe === "f") ? "L‚Äôint√©ress√©e" : "L‚Äôint√©ress√©";

    // Phrase sur la pi√®ce d'identit√©
    if (phrasePiece) {
      if (piece) {
        phrasePiece.innerHTML =
          "‚Äî " + interesse + " obtemp√®re et est en mesure de nous pr√©senter un document de type : " +
          "<span id=\"piece_type_o\">" + piece + "</span>. ‚Äî";
      } else {
        phrasePiece.innerHTML =
          "‚Äî " + interesse + " n‚Äôest pas en mesure de nous pr√©senter de document permettant de justifier de son identit√©. ‚Äî";
      }
    }

    // Bloc identit√© pi√©ton
    if (identiteBloc) {
      identiteBloc.innerHTML =
        "‚Äî " + (sexe === "f" ? "Madame " : "Monsieur ") + nom + " " + prenom +
        " n√©" + (sexe === "f" ? "e" : "") + " le " + naissance +
        ", √† " + lieuNais +
        ", de nationalit√© " + nationalite +
        ", de sexe " + (sexe === "f" ? "f√©minin" : "masculin") +
        ". L‚Äôindividu parle fran√ßais. <span id='source_identite_o'>" +
        (piece ? "Son identit√© est relev√©e sur les pi√®ces pr√©cit√©es." : "selon sa d√©claration verbale.") +
        "</span> ‚Äî";
    }
  }

  // Mets √† jour √† chaque changement des champs
  document.addEventListener("change", (e)=>{
    if([
      "veh_type","esi_hconstat","lieu_controle","piece_id",
      "esi_nom","esi_prenom","esi_dnaiss","esi_lnaiss","esi_nat","esi_sexe"
    ].includes(e.target.id)){
      majTextePieton();
    }
  });

  document.addEventListener("DOMContentLoaded", majTextePieton);
})();

</script>
<script>
(function () {
  function majAffichageType() {
    const veh = document.getElementById("texte-vehicule");
    const pie = document.getElementById("texte-pieton");
    const sel = document.getElementById("veh_type");

    if (!sel || !veh || !pie) {
      console.warn("Bascule: √©l√©ment manquant",
        { sel: !!sel, veh: !!veh, pie: !!pie });
      return;
    }

    const v = (sel.value || "").toLowerCase();
    // bascule affichage
    if (v === "personne") {
      veh.style.display = "none";
      pie.style.display = "block";
    } else {
      veh.style.display = "block";
      pie.style.display = "none";
    }
  }

  function bindBascule() {
    const sel = document.getElementById("veh_type");
    if (sel && !sel._pietonBound) {
      sel.addEventListener("change", majAffichageType);
      sel._pietonBound = true;
    }
    // applique l'√©tat actuel (utile au rechargement)
    majAffichageType();
  }

  // 1) Quand le DOM est pr√™t
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bindBascule);
  } else {
    bindBascule();
  }

  // 2) Apr√®s ta g√©n√©ration PV (si elle existe), on r√©applique la bascule
  if (typeof window.generatePV === "function" && !window._wrapGenPV_forPieton) {
    const orig = window.generatePV;
    window.generatePV = function () {
      const out = orig.apply(this, arguments);
      try { majAffichageType(); } catch (e) {}
      return out;
    };
    window._wrapGenPV_forPieton = true;
  }
})();
</script>
<script>
// === MISE √Ä JOUR DES SIGNATURES ET TITRES SELON QUALIT√â ET NOMBRE D‚ÄôASSISTANTS ===
function majSignaturesEtTitres() {
  const qualite = (document.getElementById("esr_qualite")?.value || "").trim();
  const assistants = document.querySelectorAll('#assist_list > div').length;

  // === COLONNE DE GAUCHE ===
  const colonneGauche = document.getElementById("sign_col_g");
  if (colonneGauche) {
    // Texte qualit√© abr√©g√©e (haut du PV)
    let qualiteCourte = "Le r√©dacteur";
    if (qualite.match(/opj/i)) qualiteCourte = "L‚ÄôOPJ";
    else if (qualite.match(/apja/i)) qualiteCourte = "L‚ÄôAPJA";
    else if (qualite.match(/apj/i)) qualiteCourte = "L‚ÄôAPJ";

    // Texte assistants
    const assistantsTexte = assistants > 1 ? "Les assistants" : "L‚Äôassistant";

    // Injection
    colonneGauche.textContent = `${qualiteCourte}               ${assistantsTexte}`;
  }

  // === SIGNATURE EN BAS ===
  const celluleRedacteur = document.querySelector('.signzone .signcell:first-child');
  const celluleAssistants = document.querySelector('.signzone .signcell:last-child');

  if (celluleRedacteur) {
    // Texte complet de la qualit√© pour signature
    let qualiteLongue = "Le r√©dacteur";
    if (qualite.match(/opj/i)) qualiteLongue = "L‚ÄôOfficier de Police Judiciaire";
    else if (qualite.match(/apja/i)) qualiteLongue = "L‚ÄôAgent de Police Judiciaire Adjoint";
    else if (qualite.match(/apj/i)) qualiteLongue = "L‚ÄôAgent de Police Judiciaire";

    celluleRedacteur.textContent = qualiteLongue;
  }

  if (celluleAssistants) {
    const assistantsTexte = assistants > 1 ? "Les assistants" : "L‚Äôassistant";
    celluleAssistants.textContent = assistantsTexte;
  }
}

// Ex√©cution automatique √† chaque changement de qualit√© ou d‚Äôassistants
document.addEventListener("input", e => {
  if (["esr_qualite"].includes(e.target.id)) majSignaturesEtTitres();
});
document.addEventListener("click", e => {
  if (e.target.matches(".btn-add-assistant, .btn-remove-assistant")) {
    setTimeout(majSignaturesEtTitres, 100);
  }
});

// Ex√©cution au chargement et √† chaque g√©n√©ration de PV
window.addEventListener("load", majSignaturesEtTitres);
if (typeof generatePV === "function" && !window._signaturesBound) {
  const orig = generatePV;
  window.generatePV = function () {
    const out = orig.apply(this, arguments);
    try { majSignaturesEtTitres(); } catch(e) {}
    return out;
  };
  window._signaturesBound = true;
}

</script>

</body>
</html>
