<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>PV Interpellation â€” ESI</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#003366" />
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
  :root {
    --page-w:210mm;
    --page-h:297mm;
    --m-left:10mm;
    --m-others:10mm;
    --ui:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
    --serif:"Times New Roman", Times, serif;
    --brand:#003366;
    --muted:#6b7280;
  }


  * { box-sizing:border-box; }

  html, body {
    margin:0;
    padding:0;
    background:#fff;
    color:#222;
    font-family:var(--ui);
  }

  .wrap {
    max-width:980px;
    margin:18px auto;
    padding:16px;
  }

  .toolbar {
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:center;
    margin-bottom:14px;
  }

  .toolbar button {
    padding:10px 14px;
    border:0;
    border-radius:10px;
    background:var(--brand);
    color:#fff;
    cursor:pointer;
    font-size:15px;
  }

  .toolbar button.secondary {
    background:#0d5bd7;
  }

  .toolbar button:active {
    transform:translateY(1px);
  }

  .grid {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin-bottom:12px;
  }

  fieldset {
    border:1px solid #d0d7de;
    border-radius:10px;
    padding:12px;
    background:#a8c7ff;
  }

  legend {
    padding:0 8px;
    color:#111;
    font-weight:700;
  }

  label {
    display:block;
    font-size:14px;
    margin:8px 0 4px;
  }

  input, select, textarea {
    width:100%;
    padding:10px;
    border:1px solid #c9c9c9;
    border-radius:8px;
    font-size:14px;
  }

  .row {
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }

  .row3 {
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:10px;
  }

  /* ======== FEUILLE A4 IMPRIMABLE ======== */
  #sheet {
    width:var(--page-w);
    height:var(--page-h);
    margin:0 auto;
    background:#fff;
    color:#000;
    font-family:var(--serif);
    padding:10mm 10mm 20mm var(--m-left);
    display:none;
    grid-template-columns:58mm 1fr;
    gap:8mm;
    position:relative;
  }

  #sheet .col-g {
    border-right:1px solid #cfcfcf;
    padding-right:5mm;
  }

  #sheet .col-d {
    padding-left:4mm;
    text-align:justify;
    line-height:1.42;
  }

  .logo {
    width:60mm;
    margin:0 0 8mm 0;
  }

  .title-left {
    font-weight:bold;
  }

  .num-pv {
    margin-top:8mm;
    font-style:italic;
  }

  .signzone {
    margin-top:16mm;
    display:grid;
    grid-template-columns:1fr 1fr;
  }

  .signcell {
    min-height:28mm;
    border-top:1px solid #aaa;
    padding-top:4mm;
  }

  /* ======== RESPONSIVE DESIGN ======== */

  @media (max-width: 900px) {
    .wrap {
      padding:12px;
      margin:10px;
    }
    .grid, .row, .row3 {
      grid-template-columns:1fr; /* Les champs sâ€™empilent */
    }
    fieldset {
      padding:10px;
    }
  }

  @media (max-width: 600px) {
    body {
      font-size:15px;
    }
    .toolbar {
      flex-direction:column;
      gap:10px;
    }
    .toolbar button {
      width:100%;
      font-size:16px;
    }
    input, select, textarea {
      font-size:16px; /* Ã‰vite le zoom sur iPhone */
    }
    .wrap {
      padding:10px;
    }
  }

  /* Impression : ne garder que #sheet */
  @media print {
    body>*:not(#sheet){display:none !important}
    #sheet{display:grid !important;position:static;margin:0}
  }
  
.add-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  background: #003366;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 10px 14px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
}

.add-btn:hover {
  background: #0055aa;
  transform: scale(1.05);
}

.add-btn:active {
  transform: scale(0.97);
  background: #002244;
}

.add-btn i {
  font-size: 18px;
}
#listePV {
  background:#eef3ff;
  border-radius:12px;
  margin:20px auto;
  max-width:800px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

</style>
</head>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<body>
  <div class="wrap">
    <div class="toolbar">
      <button onclick="generatePV()">ğŸ§¾ GÃ©nÃ©rer le PV</button>
     <button class="secondary" onclick="openPrintPreview()">ğŸ–¨ï¸ Imprimer / PDF</button>
	<button onclick="sauvegarderPV()">ğŸ’¾ Sauvegarder le PV</button>
  <button onclick="ouvrirMesPV()">ğŸ“ Mes PV sauvegardÃ©s</button>
  <button onclick="nouveauPV()">ğŸ†• Nouveau PV</button>

	</div>

    <div class="grid">
      <fieldset>
        <legend>ESR (rÃ©dacteur)</legend>
        <label>Grade</label>
        <input id="esr_grade" placeholder="ex: Gendarme" />
        <label>Nom</label>
        <input id="esr_nom"
       placeholder="NOM"
       style="text-transform:uppercase"
       oninput="this.value=this.value.toUpperCase()"
       autocorrect="off"
       autocapitalize="characters"
       spellcheck="false">
        <label>PrÃ©nom</label>
        <input id="esr_prenom" placeholder="PrÃ©nom" />
        <label>Sexe ESR (accord de Â« assistÃ©(e) Â»)</label>
        <select id="esr_sexe"><option value="m">Masculin</option><option value="f">FÃ©minin</option></select>
     <label>QualitÃ©</label>
<select id="esr_qualite">
  <option value="">â€” SÃ©lectionner â€”</option>
  <option value="APJA">APJA</option>
  <option value="APJ">APJ</option>
  <option value="OPJ">OPJ</option>
  <option value="AFP">AFP</option>
</select>



        <label>Affectation</label>
        <input id="esr_affect" placeholder="ex: CRT 06/1 Nice" />
        <div class="row">
          <div>
            <label>NumÃ©ro de PV</label>
            <input id="pv_num" placeholder="(ex: 2025 / )" />
          </div>
          <div>
            
      </fieldset>

      <fieldset>
        <legend>Assistants (multi)</legend>
        <div id="assist_list"></div>
        <button type="button" class="add-btn" onclick="addAssistant()">
  <i class="fa-solid fa-user-plus"></i> Ajouter un assistant
</button>

      </fieldset>

      <fieldset>
        <legend>Mission</legend>
        <label>Lieu de mission (texte exact)</label>
        <input id="mission_lieu" placeholder="ex: la Turbie" />
        <div class="row">
          <div>
            <label>Heure dÃ©but</label>
            <input id="mission_hdeb" type="time" />
          </div>
          <div>
            <label>Heure fin</label>
            <input id="mission_hfin" type="time" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Date (lettres)</label>
            <input id="date_lettres" placeholder="17 Juillet" />
          </div>
          <div>
            <label>Heure avant constatation</label>
            <input id="heure_lettres" type="time" placeholder="16 heures et 25 minutes" />
      </div>
        </div>
 
      </fieldset>

      <fieldset>
        <legend>ESI contrÃ´lÃ©</legend>
        <div class="row">
          <div>
            <label>Heure de constatation (lettres)</label>
            <input id="esi_hconstat" type="time" placeholder="16 heures et 30 minutes" />
          </div>
          <div>
            <label>VÃ©hicule</label>
            <select id="veh_type">
              <option>bus</option>
              <option>train</option>
              <option>VL</option>
              <option>PL</option>
            </select>
          </div>
        </div>
		<label>Marque du vÃ©hicule/Compagnie du train</label>
<input id="veh_marque"placeholder="ex:Mercedes,Renault/Train ex: Tranitalia" />

        <label>Immatriculation / nÂ° de train</label>
        <input id="veh_immat" 
       placeholder="AA-123-BB / TGV 6123" 
       style="text-transform:uppercase" 
       oninput="this.value=this.value.toUpperCase()" 
       autocorrect="off" 
       autocapitalize="characters" 
       spellcheck="false">
		<label>Pays dâ€™immatriculation</label>
<input id="veh_pays" placeholder="ex: Italie" />
<label>Conducteur / Conductrice</label>
<select id="conducteur_genre">
  <option value="m">Conducteur</option>
  <option value="f">Conductrice</option>
</select>

        <label>Lieu du contrÃ´le</label>
        <input id="lieu_controle" placeholder="SUR l'aire de repos /le bas cÃ´tÃ©/le quai de gare" 
autocapitalize="off"
       autocorrect="off"
       spellcheck="false">
        <label>PiÃ¨ce dâ€™identitÃ© prÃ©sentÃ©e</label>
        <input id="piece_id" placeholder="ex: passeport sans visa/ titre de sÃ©jour pÃ©rimÃ©"
autocapitalize="off"
       autocorrect="off"
       spellcheck="false">
        <div class="row3">
          <div>
<small>âš ï¸SI PAS DE PIECE D'IDENTITÃ‰ NE RIEN ECRIREâš ï¸
            <label>Nom</label>
            <input id="esi_nom"
       placeholder="NOM ESI"
       style="text-transform:uppercase"
       oninput="this.value=this.value.toUpperCase()"
       autocorrect="off"
       autocapitalize="characters"
       spellcheck="false">
          </div>
          <div>
            <label>PrÃ©nom</label>
            <input id="esi_prenom" placeholder="prÃ©nom esi" />
          </div>
          <div>
            <label>Sexe</label>
            <select id="esi_sexe"><option value="m">Masculin</option><option value="f">FÃ©minin</option></select>
          </div>
        </div>
        <div class="row3">
          <div>
            <label>Date de naissance</label>
            <input id="esi_dnaiss" placeholder="01/01/1992" />
          </div>
          <div>
            <label>Lieu de naissance</label>
            <input id="esi_lnaiss" placeholder="ex:DAKAR (SENEGAL)"
style="text-transform:uppercase" 
       oninput="this.value=this.value.toUpperCase()" 
       autocorrect="off" 
       autocapitalize="characters" 
       spellcheck="false">
          </div>
          <div>
            <label>NationalitÃ©</label>
            <input id="esi_nat" placeholder="ex: sÃ©nÃ©galaise" 
autocapitalize="off"
       autocorrect="off"
       spellcheck="false">
          </div>
        </div>
		<label>Langue parlÃ©e</label>
<select id="esi_langue">
  <option value="fr_ok">Parle franÃ§ais</option>
  <option value="fr_approx">FranÃ§ais approximatif</option>
  <option value="npf">Ne parle pas franÃ§ais</option>
</select>

        <div class="row3">
          <div>
            <label>FPR</label>
            <select id="fpr"><option>NÃ©gatif</option><option>Positif</option></select>
          </div>
          <div>
            <label>AGDREF</label>
            <select id="agdref"><option>NÃ©gatif</option><option>Positif</option></select>
          </div>
          <div>
            <label>Fichiers nationaux (ex:OQTF,RAS,AUTRE)</label>
            <input id="fichiers_nat" placeholder="OQTF" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Palpation (genre de lâ€™agent qui palpe)</label>
            <select id="palp_genre"><option value="m">Masculin</option><option value="f">FÃ©minin</option></select>
          </div>
          <div>
            <label>VÃ©hicule de transport</label>
            <select id="transport_type"><option>GENDARMERIE</option><option>Translation Police</option></select>
          </div>
        </div>
        <label>PAF de prÃ©sentation (ville)</label>
        <input id="paf_ville" placeholder="Menton / Nice / AÃ©roport" />
		<label>Heure de prÃ©sentation Ã  la PAF</label>
<input id="paf_heure" type="time" placeholder="ex: 17 heures et 10 minutes" />

      </fieldset>
    </div>
  </div>
<div id="listePV" style="display:none; padding:20px;">
  <h2>ğŸ“ Mes PV sauvegardÃ©s</h2>
  <div id="listePVcontenu"></div>
  <button onclick="fermerMesPV()" style="margin-top:10px;">â¬…ï¸ Retour</button>
</div>
  <!-- ======== FEUILLE IMPRIMABLE (MISE EN PAGE FIXE) ======== -->
  <div id="sheet">
    <div class="col-g">
      <div class="title-left">MINISTERE DE L'INTERIEUR</div>
      <div style="margin-top:2mm"></div>
      <hr style="border:none;border-top:1px solid #000;margin:3mm 0 2mm 0">
      <div class="title-left" style="white-space:pre-line">DIRECTION GENERALE
DE LA POLICE NATIONALE
DIRECTION GÃ‰NÃ‰RALE DE LA GENDARMERIE     NATIONALE</div>
      <div class="num-pv">NUMÃ‰RO DE P.V. : <span id="pv_num_o"></span></div>

      <div style="margin-top:8mm">AFFAIRE :</div>
     
      <div style="margin-top:8mm"><span id="esi_civil_left_o">Monsieur</span> <span id="aff_nomcomplet_o">THIAM Mamadou Moustapha</span></div>
      <div style="margin-top:6mm">OBJET :</div>
      <div>Rapport de saisine</div>
      <div style="margin-top:6mm">SAISINE :</div>
      <div>Interpellation dâ€™Ã©tranger en situation irrÃ©guliÃ¨re.</div>

      <div style="margin-top:18mm">Lâ€™assistantÂ Â Â Â Â Â Â Â Â Â Â Lâ€™APJA</div>
    </div>

    <div class="col-d">
      <div style="text-align:center;font-weight:bold;font-size:1.6em;letter-spacing:1px;">
  RÃ‰PUBLIQUE FRANÃ‡AISE
</div>
<div style="text-align:center;font-weight:bold;margin-top:3mm;font-size:1.3em;">
  RAPPORT DE SAISINE
</div>
<div style="height:10mm;"></div>

      <p>L'an deux mil vingt-cinq,</p>
      <p>Le <span id="date_lettres_o">17 Juillet</span>, Ã  <span id="heure_lettres_o">16 heures et 25 minutes</span></p>
      <p>NOUS :</p>

      <p>SoussignÃ©, <span id="esr_grade_o">Grade</span> <span id="esr_nom_o">Nom</span> <span id="esr_prenom_o">PrÃ©nom</span>, <span id="esr_qualite_o">Agent de Police Judiciaire Adjoint / APJA</span>, affectÃ© Ã  la <span id="esr_affect_o">CRT 06/1 Nice</span>,</p>

      <p>AssistÃ©<span id="assist_e_o"> </span> du <span id="assist_list_o">Grade Nom PrÃ©nom, Agent de Police Judiciaire Adjoint (APJA), affectÃ© Ã  la CRT</span></p>

      <p>En fonction du Groupement de Gendarmerie DÃ©partementale des Alpes Maritimes, et dÃ©tachÃ©s pour emplois au profit de Lutte contre lâ€™Immigration IrrÃ©guliÃ¨re et Clandestine, dans le cadre du dispositif Border Force 06</p>

      <p>â€” Nous trouvant en mission de lutte contre lâ€™immigration irrÃ©guliÃ¨re et clandestine dans le dÃ©partement des Alpes-Maritimes (06) au point de passage autorisÃ© de <span id="mission_lieu_o">la Turbie</span> ce jour de <span id="mission_hdeb_o">15</span> Ã  <span id="mission_hfin_o">23</span> . â€”</p>

      <p>â€” Mis temporairement et nominativement Ã  la disposition de Monsieur le PrÃ©fet des Alpes-Maritimes, aux fins d'assurer une mission de lutte contre l'immigration irrÃ©guliÃ¨re dans le dÃ©partement des Alpes-Maritimes, â€”</p>

      <p>â€” Agissant conformÃ©ment aux instructions reÃ§ues de Madame la Commissaire Divisionnaire Emmanuelle JOUBERT, Cheffe du Service DÃ©partemental de la Police aux FrontiÃ¨res des Alpes-Maritimes, â€”</p>

      <p>â€” Vu l'article 21-1 du code de procÃ©dure pÃ©nale, â€”</p>
      <p>â€” Vu les articles 20, D13 D14 et D15 du code de procÃ©dure pÃ©nale,</p>
      <p>â€” PlacÃ©s sous l'Ã©gide de la coordination dÃ©partementale de la police aux frontiÃ¨res pour assurer la mission de contrÃ´le des points de passage frontaliers, â€”</p>
      <p>â€” Vu le titre II du rÃ¨glement (UE) 2016/399 du Parlement europÃ©en et du Conseil du 9 mars 2016 concernant un code de lâ€™Union relatif au rÃ©gime de franchissement des frontiÃ¨res par les personnes (code frontiÃ¨re Schengen) JO L 077 du 23 mars 2016, p.1. â€”</p>
      <p>â€” Vu les articles 5 Ã  8, 14 et 32 de ce rÃ¨glement. â€”</p>
      <p>â€” Vu la note des autoritÃ©s franÃ§aises notifiant au premier Vice-prÃ©sident de la commission europÃ©enne son intention, Ã  compter du 1er mai 2025 et jusquâ€™au 31 octobre 2025, de prolonger le rÃ©tablissement des contrÃ´les aux frontiÃ¨res intÃ©rieures de la France avec la Belgique, le Luxembourg, lâ€™Allemagne, lâ€™Italie, lâ€™Espagne, et la confÃ©dÃ©ration Suisse, sur le fondement des articles 25 et 27 du rÃ¨glement 2016/399 susvisÃ©. â€”</p>
      <p>â€” RevÃªtus de nos uniformes rÃ©glementaires et insignes affÃ©rents Ã  notre fonction et munis du gilet rÃ©flÃ©chissant GENDARMERIE, â€”</p>
      
      <p>â€” â€” Ã€ <span id="esi_hconstat_o">16 heures et 30 minutes</span>, nous constatons la prÃ©sence dâ€™un <span id="veh_type_o">autobus</span> <span id="veh_marque_o">Mercedes</span> immatriculÃ© <span id="veh_pays_o">en Italie</span> sous le numÃ©ro <span id="veh_immat_o">GT-503-RE</span> en circulation et arrivant dans notre direction  â€”
	  <p>â€” Faisons signe rÃ©glementairement <span id="conducteur_article_o">au</span> <span id="conducteur_label_o">conducteur</span> de stationner son vÃ©hicule correctement et en sÃ©curitÃ© <span id="lieu_controle_o">sur le parking de lâ€™aire de repos du pÃ©age de La Turbie</span>, afin de procÃ©der au contrÃ´le de lâ€™identitÃ© des passagers du vÃ©hicule. â€”</p>
      <p>â€” <span id="conducteur_article2_o">Le</span> <span id="conducteur_label2_o">conducteur</span> obtempÃ¨re Ã  notre demande, dÃ©clinons notre qualitÃ© et le motif de notre contrÃ´le. â€”</p>
	  <p>â€” ProcÃ©dons au contrÃ´le d'identitÃ© des personnes Ã  bord du vÃ©hicule.</p>

      <p id="piece_phrase_o">
â€” Ã€ son bord, <span id="passager_article_o">un</span> <span id="passager_label_o">passager</span>
<span id="piece_phrase_part_o">est en mesure de nous prÃ©senter un passeport</span>.
<span id="individu_phrase_o">Cet individu</span> nâ€™Ã©tant pas en mesure de nous prÃ©senter de document dâ€™identitÃ© ou de voyage en cours de validitÃ©,
<span id="passager_pronom_o">ce dernier</span> nâ€™est donc pas en rÃ¨gle pour voyager, circuler ou sÃ©journer sur le territoire national franÃ§ais. â€”
</p>

      <p>â€” Il sâ€™agit de : â€”</p>

      <p id="esi_lang_phrase_o">
â€” <span id="esi_civil_o">Monsieur</span> <span id="esi_nom_o">THIAM</span> <span id="esi_prenom_o">Mamadou Moustapha</span> nÃ©<span id="esi_nee_o"></span> le <span id="esi_dnaiss_o">01/01/1992</span> Ã  <span id="esi_lnaiss_o">DAKAR (SENEGAL)</span>, de nationalitÃ© <span id="esi_nat_o">sÃ©nÃ©galaise</span>, de sexe <span id="esi_sexe_o">masculin</span>. <span id="langue_phrase_o">Lâ€™individu sâ€™exprime en franÃ§ais approximatif.</span> <span id="identite_phrase_o">Son identitÃ© est relevÃ©e sur les piÃ¨ces prÃ©citÃ©es.</span> â€”
</p>

      <p>â€” Effectuons des recherches concernant cette personne auprÃ¨s des fichiers de Police mis Ã  notre disposition, Ã  lâ€™aide de notre tablette de service : â€”</p>

      <p>â€” FPR : <span id="fpr_o">NÃ©gatif</span> â€”</p>
      <p>â€” AGDREF : <span id="agdref_o">NÃ©gatif</span> â€”</p>
      <p>â€”Aux fichiers Nationaux il appert quâ€™Ã  ce jour et sous cette identitÃ© : <span id="fichiers_nat_o">il a fait lâ€™objet dâ€™une OQTF</span> â€”</p>
      <p>â€” Rendons immÃ©diatement compte des faits Ã  lâ€™Officier de Police Judiciaire Territorialement CompÃ©tent de permanence du poste de la Police Aux FrontiÃ¨res de <span id="paf_ville_o1">Saint Louis Ã  Menton</span>, qui nous donne lâ€™ordre de lui prÃ©senter <span id="esi_civil2_o">Monsieur</span> <span id="esi_nom2_o">THIAM</span> <span id="esi_prenom2_o">Mamadou Moustapha</span> dans les plus brefs dÃ©lais. â€”</p>
      <p>â€” DÃ¨s lors, nous nous trouvons en prÃ©sence <span id="esi_etranger_phrase_o">dâ€™un Ã©tranger</span> en situation irrÃ©guliÃ¨re au voyage, Ã  la circulation ou au sÃ©jour sur le territoire national franÃ§ais, â€”</p>
      <p>â€” Agissant en vertu des articles L813-1 Ã  L813-16 du Code de lâ€™EntrÃ©e et du SÃ©jour des Ã‰trangers et du Droit dâ€™Asile, â€”</p>
      <p>â€” Informons la personne quâ€™elle se trouve en situation irrÃ©guliÃ¨re sur le territoire national franÃ§ais. â€”</p>
      <p>â€” Invitons <span id="esi_civil3_o">Monsieur</span> <span id="esi_nom3_o">THIAM</span> <span id="esi_prenom3_o">Mamadou Moustapha</span> Ã  nous suivre. â€”</p>
      <p>â€” <span id="palp_phrase_o">PalpÃ© par mesure de sÃ©curitÃ©, par un personnel masculin, il nâ€™est trouvÃ© porteur dâ€™aucun objet dangereux pour autrui ou pour lui-mÃªme</span>. â€”</p>
      <p>â€” <span id="transport_phrase_o">
Transportons lâ€™individu sans contrainte ni entraves au poste de la Police Aux FrontiÃ¨res de Saint Louis Ã  Menton, Ã  bord de notre vÃ©hicule de service sÃ©rigraphiÃ© Â« GENDARMERIE Â».
</span> â€”</p>
      <p>â€” PrÃ©sentons lâ€™individu devant lâ€™Officier de Police Judiciaire Territorialement CompÃ©tent de permanence du poste de la Police Aux FrontiÃ¨res de <span id="paf_ville_o3">Saint Louis Ã  Menton</span> Ã  <span id="paf_heure_o">17 heures et 10 minutes</span>. Lâ€™horaire de prÃ©sentation Ã©tant diffÃ©rÃ© eu Ã©gard au dÃ©lai de route. â€”</p>

		<div class="signzone">
        <div class="signcell">Lâ€™assistant</div>
        <div class="signcell">Lâ€™APJA</div>
      </div>
    </div>
  </div>

<script>
  let assistIndex = 0;
  function addAssistant(){
    assistIndex++;
    const wrap = document.getElementById('assist_list');
    const div = document.createElement('div');
    div.style.marginBottom = '8px';
    div.innerHTML = `
      <div class="row">
        <div>
          <label>Grade</label>
          <input id="a_grade_${assistIndex}" placeholder="ex: Gendarme" />
        </div>
        <div>
          <label>Nom</label>
          <input id="a_nom_${assistIndex}" 
       placeholder="NOM"
       style="text-transform:uppercase"
       oninput="this.value=this.value.toUpperCase()"
       autocorrect="off"
       autocapitalize="characters"
       spellcheck="false">
        </div>
      </div>
      <label>PrÃ©nom</label>
      <input id="a_prenom_${assistIndex}" placeholder="PrÃ©nom" />
     <label>QualitÃ©</label>
<select id="a_qual_${assistIndex}">
  <option value="">â€” SÃ©lectionner â€”</option>
  <option value="APJA">APJA</option>
  <option value="APJ">APJ</option>
  <option value="OPJ">OPJ</option>
  <option value="AFP">AFP</option>
</select>


      <label>Affectation</label>
      <input id="a_affect_${assistIndex}" placeholder="ex: CRT 06/2 Cannes" />
      <hr style="margin:10px 0;border:none;border-top:1px dashed #ddd">`;
    wrap.appendChild(div);
  }
  // Un assistant par dÃ©faut
  addAssistant();

  function setTxt(id, v){ const el=document.getElementById(id); if(el) el.textContent = v || ''; }

  function accordAssistEsr(esrSexe, count){
    // renvoie la chaÃ®ne Ã  insÃ©rer aprÃ¨s "AssistÃ©"
    if(count>1) return 's';
    return esrSexe==='f' ? 'e' : '';
  }

  function civilFromSexe(sexe){ return sexe==='f' ? 'Madame' : 'Monsieur'; }
  function sexeLabel(sexe){ return sexe==='f' ? 'fÃ©minin' : 'masculin'; }
  function neeFromSexe(sexe){ return sexe==='f' ? 'e' : ''; }

// === Conversion automatique des abrÃ©viations de qualitÃ© ===
function qualiteLongue(code) {
  switch ((code || '').toUpperCase()) {
    case 'APJA': return 'Agent de Police Judiciaire Adjoint (APJA)';
    case 'APJ':  return 'Agent de Police Judiciaire (APJ)';
    case 'OPJ':  return 'Officier de Police Judiciaire (OPJ)';
    case 'AFP':  return 'Agent de la Force Publique (AFP)';
    default:     return code;
  }
}

  function generatePV(){
  
  // Fonction utilitaire : convertir HH:MM en texte
function heureEnLettres(hhmm) {
  if (!hhmm) return "";
  const [h, m] = hhmm.split(":").map(Number);
  let txt = `${h} heure${h > 1 ? 's' : ''}`;
  if (m > 0) txt += ` et ${m} minute${m > 1 ? 's' : ''}`;
  return txt;
}

    // ESR
    const esr_grade = document.getElementById('esr_grade').value.trim();
    const esr_nom   = document.getElementById('esr_nom').value.trim();
    const esr_prenom= document.getElementById('esr_prenom').value.trim();
    const esr_sexe  = document.getElementById('esr_sexe').value;
    const esr_qual  = document.getElementById('esr_qualite').value.trim();
	const esr_qual_long = qualiteLongue(esr_qual);
    const esr_aff   = document.getElementById('esr_affect').value.trim();


    // Assistants
    const assistants=[];
    for(let i=1;i<=assistIndex;i++){
      const g=document.getElementById('a_grade_'+i)?.value.trim();
      const n=document.getElementById('a_nom_'+i)?.value.trim();
      const p=document.getElementById('a_prenom_'+i)?.value.trim();
      const q=document.getElementById('a_qual_'+i)?.value.trim();
      const a=document.getElementById('a_affect_'+i)?.value.trim();
      if(g&&n&&p) assistants.push({g,n,p,q,a});
    }

    // Mission
    const pv_num = document.getElementById('pv_num').value.trim();
    
    const mission_lieu = document.getElementById('mission_lieu').value.trim();
    const hdeb = document.getElementById('mission_hdeb').value.trim();
    const hfin = document.getElementById('mission_hfin').value.trim();
    const dateL = document.getElementById('date_lettres').value.trim();
    const heureL= document.getElementById('heure_lettres').value.trim();

    // ESI
    const esi_hc = document.getElementById('esi_hconstat').value.trim();
    const veh_type = document.getElementById('veh_type').value;
    const veh_immat= document.getElementById('veh_immat').value.trim();
    const lieu_ctrl = document.getElementById('lieu_controle').value.trim();
	const veh_marque = document.getElementById('veh_marque').value.trim();
    const veh_pays = document.getElementById('veh_pays').value.trim();
    const piece_id = document.getElementById('piece_id').value.trim();
	const conducteur_genre = document.getElementById('conducteur_genre').value;
    const esi_nom = document.getElementById('esi_nom').value.trim();
    const esi_prenom = document.getElementById('esi_prenom').value.trim();
    const esi_sexe = document.getElementById('esi_sexe').value;
    const esi_dnaiss = document.getElementById('esi_dnaiss').value.trim();
    const esi_lnaiss = document.getElementById('esi_lnaiss').value.trim();
    const esi_nat = document.getElementById('esi_nat').value.trim();
    const fpr = document.getElementById('fpr').value;
    const agdref = document.getElementById('agdref').value;
    const fichiersNat = document.getElementById('fichiers_nat').value.trim();
    const palp_genre = document.getElementById('palp_genre').value;
    const transport_type = document.getElementById('transport_type').value;
    const paf_ville = document.getElementById('paf_ville').value.trim();
	const paf_heure = document.getElementById('paf_heure').value.trim();

	// Conversion en lettres
const hdeb_txt = heureEnLettres(hdeb);
const hfin_txt = heureEnLettres(hfin);
const hc_txt = heureEnLettres(esi_hc);
const paf_txt = heureEnLettres(paf_heure);
const heureL_txt = heureEnLettres(heureL);

    // Remplissage colonne gauche
    setTxt('pv_num_o', pv_num);

    // Nom complet affaire / entÃªte si tu veux lâ€™afficher
    setTxt('aff_nomcomplet_o', (esi_nom+" "+esi_prenom).trim());

    // En-tÃªte centre
    setTxt('date_lettres_o', dateL);
    setTxt('heure_lettres_o', heureL_txt);

    // ESR
    setTxt('esr_grade_o', esr_grade||'');
    setTxt('esr_nom_o', esr_nom||'');
    setTxt('esr_prenom_o', esr_prenom||'');
    setTxt('esr_qualite_o', esr_qual_long || '');
    setTxt('esr_affect_o', esr_aff||'');

    // Assistants rendu
    const assistSuffix = accordAssistEsr(esr_sexe, assistants.length);
    setTxt('assist_e_o', assistSuffix); // affiche e / s / vide
   const assistTxt = assistants.length
  ? assistants.map(a=>{
      const qlong = qualiteLongue(a.q || '');
      return `${a.g} ${a.n} ${a.p}${qlong?`, ${qlong}`:''}${a.a?`, affectÃ© Ã  la ${a.a}`:''}`;
    }).join('; ')
  : 'Grade Nom PrÃ©nom, Agent de Police Judiciaire Adjoint (APJA), affectÃ© Ã  la CRT';

    setTxt('assist_list_o', assistTxt);

    // Mission
    setTxt('mission_lieu_o', mission_lieu);
    setTxt('mission_hdeb_o', hdeb_txt);
	setTxt('mission_hfin_o', hfin_txt);

    // VÃ©hicule / constatation
    setTxt('esi_hconstat_o', hc_txt);
    setTxt('veh_type_o', veh_type==='train'?'train':(veh_type==='VL'?'vÃ©hicule lÃ©ger':(veh_type==='PL'?'poids lourd':'autobus')));
    setTxt('veh_pays_o', veh_pays ? 'en ' + veh_pays : '');
    setTxt('veh_marque_o', veh_marque);
    setTxt('veh_immat_o', veh_immat);
    setTxt('lieu_controle_o', lieu_ctrl);
    setTxt('piece_id_o', piece_id);
// Accord conducteur / conductrice
if (conducteur_genre === 'f') {
  setTxt('conducteur_article_o', 'Ã  la');
  setTxt('conducteur_label_o', 'conductrice');
} else {
  setTxt('conducteur_article_o', 'au');
  setTxt('conducteur_label_o', 'conducteur');
}
// DeuxiÃ¨me accord (Le conducteur / La conductrice)
if (conducteur_genre === 'f') {
  setTxt('conducteur_article2_o', 'La');
  setTxt('conducteur_label2_o', 'conductrice');
} else {
  setTxt('conducteur_article2_o', 'Le');
  setTxt('conducteur_label2_o', 'conducteur');
}

    // IdentitÃ© ESI
    const civil = civilFromSexe(esi_sexe);
    const nee = neeFromSexe(esi_sexe);
    setTxt('esi_civil_o', civil);
	setTxt('esi_civil_left_o', civil);
    setTxt('esi_nom_o', esi_nom);
    setTxt('esi_prenom_o', esi_prenom);
    setTxt('esi_nee_o', nee);
    setTxt('esi_dnaiss_o', esi_dnaiss);
    setTxt('esi_lnaiss_o', esi_lnaiss);
    setTxt('esi_nat_o', esi_nat);
    setTxt('esi_sexe_o', sexeLabel(esi_sexe));


    // Fichiers
    setTxt('fpr_o', fpr);
    setTxt('agdref_o', agdref);
    setTxt('fichiers_nat_o', fichiersNat);

    // PAF / suites
    setTxt('paf_ville_o1', paf_ville);
    setTxt('paf_ville_o2', paf_ville);
    setTxt('paf_ville_o3', paf_ville);

    // Suites â€“ civilitÃ©s rÃ©pÃ©tÃ©es
    setTxt('esi_civil2_o', civil);
    setTxt('esi_nom2_o', esi_nom);
    setTxt('esi_prenom2_o', esi_prenom);

    setTxt('esi_civil3_o', civil);
    setTxt('esi_nom3_o', esi_nom);
    setTxt('esi_prenom3_o', esi_prenom);

    // Palpation & transport
    setTxt('palp_genre_o', palp_genre==='f'?'fÃ©minin':'masculin');
	// Accord complet de la phrase de palpation selon le sexe de lâ€™ESI
(() => {
  const target = document.getElementById('palp_phrase_o');
  if (!target) return;

  const agentGenre = palp_genre === 'f' ? "fÃ©minin" : "masculin";

  if (esi_sexe === 'f') {
    target.textContent = `PalpÃ©e par mesure de sÃ©curitÃ©, par un personnel ${agentGenre}, elle nâ€™est trouvÃ©e porteuse dâ€™aucun objet dangereux pour autrui ou pour elle-mÃªme`;
  } else {
    target.textContent = `PalpÃ© par mesure de sÃ©curitÃ©, par un personnel ${agentGenre}, il nâ€™est trouvÃ© porteur dâ€™aucun objet dangereux pour autrui ou pour lui-mÃªme`;
  }
})();

    // Phrase de transport selon le type choisi
let phraseTransport = '';
if (transport_type === 'GENDARMERIE') {
  phraseTransport = `Transportons lâ€™individu sans contrainte ni entraves au poste de la Police Aux FrontiÃ¨res de ${paf_ville}, Ã  bord de notre vÃ©hicule de service sÃ©rigraphiÃ© Â« GENDARMERIE Â».`;
} else {
  phraseTransport = `Transportons lâ€™individu sans contrainte ni entraves au poste de la Police Aux FrontiÃ¨res de ${paf_ville}, Ã  bord de notre vÃ©hicule de service de translation mis Ã  disposition par la Police Nationale.`;
}
setTxt('transport_phrase_o', phraseTransport);
setTxt('paf_heure_o', paf_txt);
// Accord passager / pronom selon le sexe de l'ESI
if (esi_sexe === 'f') {
  setTxt('passager_article_o', 'une');
  setTxt('passager_label_o', 'passagÃ¨re');
  setTxt('individu_phrase_o', 'Cet individu'); // reste neutre administratif
  setTxt('passager_pronom_o', 'cette derniÃ¨re');
} else {
  setTxt('passager_article_o', 'un');
  setTxt('passager_label_o', 'passager');
  setTxt('individu_phrase_o', 'Cet individu');
  setTxt('passager_pronom_o', 'ce dernier');
}

// === Phrase dynamique selon la piÃ¨ce dâ€™identitÃ© ===
(() => {
  const pieceInput = document.getElementById('piece_id');
  const target = document.getElementById('piece_phrase_part_o');
  if (!pieceInput || !target) {
    console.warn("âš ï¸ Ã‰lÃ©ment manquant pour la phrase d'identitÃ©.");
    return;
  }

  const piece_id = pieceInput.value.trim();
  const phrase = piece_id
    ? `est en mesure de nous prÃ©senter une piÃ¨ce d'identitÃ© de type: ${piece_id}`
    : `nâ€™est pas en mesure de nous prÃ©senter un document pouvant justifier de son identitÃ©`;
  
  target.textContent = phrase;
})();

// === Langue parlÃ©e et relevÃ© d'identitÃ© ===
(() => {
  const langueSelect = document.getElementById('esi_langue');
  const pieceInput = document.getElementById('piece_id');
  const langueSpan = document.getElementById('langue_phrase_o');
  const identiteSpan = document.getElementById('identite_phrase_o');

  if (!langueSelect || !langueSpan || !identiteSpan) {
    console.warn("âš ï¸ Ã‰lÃ©ment manquant pour la langue ou l'identitÃ©.");
    return;
  }

  const langue = langueSelect.value;
  const pieceTxt = pieceInput ? pieceInput.value.trim() : '';

  // Phrase sur la langue
  let languePhrase = '';
  if (langue === 'fr_ok') {
    languePhrase = "Lâ€™individu parle franÃ§ais.";
  } else if (langue === 'fr_approx') {
    languePhrase = "Lâ€™individu sâ€™exprime en franÃ§ais approximatif.";
  } else if (langue === 'npf') {
    languePhrase = "Lâ€™individu ne parle pas franÃ§ais.";
  }

  // Phrase sur le relevÃ© d'identitÃ©
  let identitePhrase = '';
  if (pieceTxt) {
    identitePhrase = "Son identitÃ© est relevÃ©e sur les piÃ¨ces prÃ©citÃ©es.";
  } else {
    identitePhrase = "Son identitÃ© est relevÃ©e sur sa dÃ©claration verbale.";
  }

  // Injection dans le PV
  langueSpan.textContent = languePhrase;
  identiteSpan.textContent = identitePhrase;
})();

// Accord pour "Ã©tranger / Ã©trangÃ¨re"
(() => {
  const target = document.getElementById('esi_etranger_phrase_o');
  if (!target) return;
  target.textContent = esi_sexe === 'f' ? "dâ€™une Ã©trangÃ¨re" : "dâ€™un Ã©tranger";
})();


    // Affiche la feuille
    document.getElementById('sheet').style.display='grid';
    // Scroll vers la feuille pour aperÃ§u
    document.getElementById('sheet').scrollIntoView({behavior:'smooth',block:'start'});
  }
 function openPrintPreview() {
  generatePV();

  setTimeout(() => {
    const sheet = document.getElementById('sheet');
    if (!sheet) {
      alert("âš ï¸ Impossible de trouver le contenu du PV.");
      return;
    }

    // ğŸªŸ Ouvre une nouvelle fenÃªtre pour l'impression
    const printWindow = window.open('', '_blank', 'width=900,height=1000');
    printWindow.document.write(`
      <html>
      <head>
        <title>ProcÃ¨s-verbal</title>
        <style>
          @page {
            size: A4;
            margin: 10mm 10mm 20mm 10mm;
          }
		  @page :first {
  margin-top: 20mm;
  margin-bottom: 20mm;
}
@page :not(:first) {
  margin-top: 15mm;
  margin-bottom: 15mm;
}
          body {
            margin: 0;
            padding: 0;
            background: white;
            color: black;
            font-family: "Times New Roman", serif;
          }
          #sheet {
            width: 210mm;
            height: 297mm;
            display: grid;
            grid-template-columns: 58mm 1fr;
            gap: 8mm;
            padding: 10mm 10mm 10mm 10mm;
            margin: auto;
            box-sizing: border-box;
          }
          #sheet .col-g {
            border-right: 1px solid #aaa;
            padding-right: 5mm;
          }
          #sheet .col-d {
            padding-left: 4mm;
            text-align: justify;
            line-height: 1.42;
          }
          .logo {
            width: 60mm;
            margin: 0 0 8mm 0;
          }
          .title-left { font-weight: bold; }
          .num-pv { margin-top: 8mm; font-style: italic; }
          .signzone {
            margin-top: 16mm;
            display: grid;
            grid-template-columns: 1fr 1fr;
          }
          .signcell {
            min-height: 28mm;
            border-top: 1px solid #aaa;
            padding-top: 4mm;
          }
          @media print {
            body {
              margin: 0;
            }
            #sheet {
              display: grid !important;
              position: static;
              margin: 0 auto;
            }
          }
        </style>
      </head>
      <body>
        ${sheet.outerHTML}
      </body>
      </html>
    `);

    printWindow.document.close();
    printWindow.focus();
    printWindow.onload = () => printWindow.print();
  }, 600);
}

// === ğŸ’¾ SAUVEGARDE AUTOMATIQUE AVEC DEBOUNCE (inclut les assistants dynamiques) ===
let saveTimeout;

// Fonction principale de sauvegarde
function savePV() {
  const data = {};

  // Champs fixes
  const champsFixes = [
    'esr_grade','esr_nom','esr_prenom','esr_sexe','esr_qualite','esr_affect',
    'pv_num','mission_lieu','mission_hdeb','mission_hfin',
    'date_lettres','heure_lettres','esi_hconstat','veh_type','veh_marque',
    'veh_immat','veh_pays','conducteur_genre','lieu_controle','piece_id',
    'esi_nom','esi_prenom','esi_sexe','esi_dnaiss','esi_lnaiss','esi_nat',
    'esi_langue','fpr','agdref','fichiers_nat','palp_genre','transport_type',
    'paf_ville','paf_heure'
  ];

  champsFixes.forEach(id => {
    const el = document.getElementById(id);
    if (el) data[id] = el.value;
  });

  // Champs dynamiques (assistants)
  const assistants = [];
  document.querySelectorAll('#assist_list > div').forEach((div, index) => {
    const a = {
      grade: div.querySelector(`[id^="a_grade_"]`)?.value || '',
      nom: div.querySelector(`[id^="a_nom_"]`)?.value || '',
      prenom: div.querySelector(`[id^="a_prenom_"]`)?.value || '',
      qualite: div.querySelector(`[id^="a_qual_"]`)?.value || '',
      affect: div.querySelector(`[id^="a_affect_"]`)?.value || ''
    };
    assistants.push(a);
  });
  data.assistants = assistants;

  // Sauvegarde dans le localStorage
  localStorage.setItem('pv_interpellation_data', JSON.stringify(data));
  console.log("âœ… PV sauvegardÃ© automatiquement");
}

// Fonction debounce (attend 3 secondes aprÃ¨s la derniÃ¨re saisie)
function debounceSave() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(savePV, 3000);
}

// Attache lâ€™Ã©couteur Ã  tous les champs existants
function attachListeners() {
  document.querySelectorAll('input, select, textarea').forEach(el => {
    el.removeEventListener('input', debounceSave);
    el.addEventListener('input', debounceSave);
  });
}
attachListeners();

// === RECHARGEMENT AUTOMATIQUE DES DONNÃ‰ES ===
window.addEventListener('load', () => {
  const saved = localStorage.getItem('pv_interpellation_data');
  if (!saved) return;
  try {
    const data = JSON.parse(saved);

    // Champs fixes
    Object.keys(data).forEach(id => {
      const el = document.getElementById(id);
      if (el && typeof data[id] === 'string') el.value = data[id];
    });

    // Assistants dynamiques
    if (Array.isArray(data.assistants) && data.assistants.length > 0) {
      document.getElementById('assist_list').innerHTML = ''; // Nettoyage avant recharge
      assistIndex = 0;
      data.assistants.forEach(a => {
        addAssistant();
        const div = document.querySelector(`#assist_list > div:last-child`);
        div.querySelector(`[id^="a_grade_"]`).value = a.grade;
        div.querySelector(`[id^="a_nom_"]`).value = a.nom;
        div.querySelector(`[id^="a_prenom_"]`).value = a.prenom;
        div.querySelector(`[id^="a_qual_"]`).value = a.qualite;
        div.querySelector(`[id^="a_affect_"]`).value = a.affect;
      });
    }

    console.log("â™»ï¸ PV restaurÃ© avec les assistants sauvegardÃ©s");
  } catch(e) {
    console.error('Erreur chargement PV sauvegardÃ©', e);
  }
});

// === GESTION MULTI-PV ===
let pvCourantId = null; // identifiant du PV en cours d'Ã©dition

// ğŸ”¹ Sauvegarde manuelle
function sauvegarderPV() {
  const data = {};
  document.querySelectorAll('input, select, textarea').forEach(el => {
    data[el.id] = el.value;
  });

  const nomESI = document.getElementById('esi_nom').value.trim() || "Inconnu";
  const dateMission = document.getElementById('date_lettres').value.trim() || "Date ?";
  
  // ğŸ†” Si on est en train de modifier un PV existant, on garde le mÃªme id
  const id = pvCourantId || Date.now();

  const list = JSON.parse(localStorage.getItem('pv_list') || "[]");
  const index = list.findIndex(pv => pv.id === id);
  const newPV = { id, nomESI, dateMission, data };

  if (index >= 0) {
    list[index] = newPV; // on remplace le PV existant
    alert("ğŸ”„ PV mis Ã  jour !");
  } else {
    list.push(newPV); // sinon on crÃ©e un nouveau
    alert("âœ… PV sauvegardÃ© !");
	 pvCourantId = id;
  }

  localStorage.setItem('pv_list', JSON.stringify(list));
  
  // On vide le flag pour Ã©viter les doublons si on veut crÃ©er un nouveau PV ensuite
  pvCourantId = null;
}


// ğŸ”¹ Affichage de la page "Mes PV"
function ouvrirMesPV() {
  const conteneur = document.getElementById('listePVcontenu');
  const list = JSON.parse(localStorage.getItem('pv_list') || "[]");

  if (!conteneur) return alert("âš ï¸ Conteneur introuvable !");

  if (list.length === 0) {
    conteneur.innerHTML = "<p style='color:#555;text-align:center;'>Aucun PV sauvegardÃ© pour le moment.</p>";
  } else {
    conteneur.innerHTML = list.map(pv => `
      <div style="
        border:1px solid #ccc;
        padding:12px;
        margin-bottom:10px;
        border-radius:10px;
        background:#f8f9fb;
        box-shadow:0 2px 4px rgba(0,0,0,0.1);
      ">
        <strong>${pv.nomESI}</strong> â€” 
        <em>${pv.dateMission}</em><br>
        <div style="margin-top:8px;">
          <button onclick="chargerPV(${pv.id})" style="background:#0d6efd;color:white;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;">âœï¸ Modifier</button>
          <button onclick="supprimerPV(${pv.id})" style="background:#b33;color:white;border:none;padding:6px 10px;border-radius:6px;margin-left:6px;cursor:pointer;">ğŸ—‘ï¸ Effacer</button>
        </div>
      </div>
    `).join('');
  }

  document.querySelector('.wrap').style.display = "none";
  document.getElementById('sheet').style.display = "none";
  document.getElementById('listePV').style.display = "block";
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function fermerMesPV() {
  document.getElementById('listePV').style.display = "none";
  document.querySelector('.wrap').style.display = "block";
}

function chargerPV(id) {
  const list = JSON.parse(localStorage.getItem('pv_list') || "[]");
  const pv = list.find(p => p.id === id);
  if (!pv) return alert("PV introuvable !");
  
  // RÃ©injecte toutes les donnÃ©es dans les champs
  Object.keys(pv.data).forEach(k => {
    const el = document.getElementById(k);
    if (el) el.value = pv.data[k];
  });

  // Sauvegarde l'ID du PV actuellement ouvert
  pvCourantId = id;

  fermerMesPV();
   pvCourantId = id;
  alert("âœ… PV chargÃ© pour modification");
  window.scrollTo({ top: 0, behavior: 'smooth' });
}


function supprimerPV(id) {
  if (!confirm("Supprimer ce PV ?")) return;
  let list = JSON.parse(localStorage.getItem('pv_list') || "[]");
  list = list.filter(pv => pv.id !== id);
  localStorage.setItem('pv_list', JSON.stringify(list));
  ouvrirMesPV();
}
function nouveauPV() {
  if (!confirm("CrÃ©er un nouveau PV vierge ? Les champs (hors rÃ©dacteur) seront effacÃ©s.")) return;

  // Champs Ã  prÃ©server (ESR / rÃ©dacteur)
  const preserve = new Set([
    'esr_grade','esr_nom','esr_prenom','esr_sexe','esr_qualite','esr_affect','pv_num'
  ]);

  // Efface tous les champs sauf ceux du rÃ©dacteur
  document.querySelectorAll('input, select, textarea').forEach(el => {
    if (!preserve.has(el.id)) {
      if (el.tagName === 'SELECT') el.selectedIndex = 0;
      else el.value = '';
    }
  });

  // RÃ©initialise les assistants (1 bloc vide)
  const assistList = document.getElementById('assist_list');
  if (assistList) {
    assistList.innerHTML = '';
    if (typeof assistIndex !== 'undefined') assistIndex = 0;
    if (typeof addAssistant === 'function') addAssistant();
  }

  // Cache la feuille gÃ©nÃ©rÃ©e si affichÃ©e
  const sheet = document.getElementById('sheet');
  if (sheet) sheet.style.display = 'none';

  // On repart sur un nouveau PV (pas de mise Ã  jour sur lâ€™ancien)
  if (typeof pvCourantId !== 'undefined') pvCourantId = null;

  // (Optionnel) IncrÃ©ment auto du numÃ©ro de fiche si tu utilises #fiche_id
  const ficheField = document.getElementById('fiche_id');
  if (ficheField) {
    let last = parseInt(localStorage.getItem('dernier_num_fiche') || '0', 10) + 1;
    localStorage.setItem('dernier_num_fiche', String(last));
    ficheField.value = `FICHE-${String(last).padStart(3, '0')}`;
  }

  // Sauvegarde immÃ©diate si ta fonction existe (facultatif)
  if (typeof savePV === 'function') savePV();

  window.scrollTo({ top: 0, behavior: 'smooth' });
  alert("âœ… Nouveau PV vierge prÃªt (infos rÃ©dacteur conservÃ©es).");
}

 
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log('âœ… Service Worker PV ESI enregistrÃ© !'))
    .catch(err => console.error('âŒ Erreur SW:', err));
}
</script>
</body>
</html>
